z_uccfe7:--z_uccfe7
 
SET QUOTED_IDENTIFIER OFF

declare @t_bproductno nvarchar(30) = case when '#non'=[1] then '' else [1] end
declare @t_eproductno nvarchar(30) = case when '#non'=[2] then char(255) else [2] end
declare @t_bdate nvarchar(10) = case when '#non'=[6] then '' else [6] end
declare @t_edate nvarchar(10) = case when '#non'=[7] then char(255) else [7] end
declare @t_bcustno nvarchar(30) = case when '#non'=[15] then '' else [15] end
declare @t_ecustno nvarchar(30) = case when '#non'=[16] then char(255) else [16] end
declare @t_bsalesno nvarchar(20) = case when '#non'=[17] then '' else [17] end
declare @t_esalesno nvarchar(20) = case when '#non'=[18] then char(255) else [18] end
declare @t_trantype nvarchar(20) = case when '#non'=[19] then '' else [19] end
declare @t_sel nvarchar(20) = case when '#non'=[20] then '' else [20] end
--------------------------------------------------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	typea nvarchar(10),
	noa nvarchar(30),
	paytype nvarchar(100),
	days float,
	ranks int,
	rankd nvarchar(50),
	salesno nvarchar(30),
	custno nvarchar(30),
	grp nvarchar(10),
	productno nvarchar(30),
	mount float,
	weight float,
	salemoney float,
	basemoney float,
	tranmoney2 float,
	wcost float,
	interest float,
	profit float,
	rate decimal(15,2)
)
insert into @tmp(gno,noa,typea,paytype,salesno,custno,grp,productno,mount,weight,salemoney,basemoney,tranmoney2,wcost)
select 
	'9',a.noa,a.typea,a.paytype,a.salesno,a.custno,c.memo,b.productno,b.mount,b.weight,b.total,
	case when UPPER(b.unit)='KG' or RTRIM(LTRIM(b.unit))='' 
		 then ROUND(b.weight*(case when b.sprice2>0 then b.sprice2 else b.sprice end),0) 
		 else ROUND(b.mount*(case when b.sprice2>0 then b.sprice2 else b.sprice end),0) end,b.tranmoney2,
	case when UPPER(b.unit)='KG' or RTRIM(LTRIM(b.unit))='' then b.wcost*b.weight else b.wcost*b.mount end
from view_vcc a
left join view_vccs b on a.noa=b.noa
left join ucc c on b.productno=c.noa
where (a.datea between @t_bdate and @t_edate)and
	  (a.custno between @t_bcustno and @t_ecustno)and
	  (a.salesno between @t_bsalesno and @t_esalesno)and
	  (LEN(@t_trantype)=0 or a.trantype=@t_trantype)and
	  (b.productno between @t_bproductno and @t_eproductno)and
	  (CHARINDEX('1',@t_sel)=0 or a.typea='2')and
	  (b.lengthb=0)

--取收款方式天數(供算利息)
declare @noa nvarchar(30)
declare @paytype nvarchar(100)
declare @num nvarchar(10)
declare @i int
  
declare cursor_table cursor for 
select noa,paytype from @tmp
open cursor_table 
fetch next from cursor_table 
into @noa,@paytype
while(@@FETCH_STATUS <> -1) 
begin
	set @num = ''
	set @i = 1
	
	while(@i <= LEN(@paytype))
	begin
		if(ASCII(SUBSTRING(@paytype,@i,1))>=48 and ASCII(SUBSTRING(@paytype,@i,1))<=57)
			set @num = @num+char(ASCII(SUBSTRING(@paytype,@i,1)))
		set @i = @i + 1	
	end
	
	update @tmp set days = CAST(@num as int) where noa=@noa

	fetch next from cursor_table 
	into @noa,@paytype
end 
close cursor_table 
deallocate cursor_table    

--3:業務分析 4:業務排行榜
if(CHARINDEX('3',@t_sel)>0 or CHARINDEX('4',@t_sel)>0)
begin    
	insert into @tmp(gno,salesno,grp,productno,mount,weight,salemoney,basemoney,tranmoney2,wcost,interest)	  
	select 
		'0',salesno,grp,productno,
		SUM(case when typea='1' then mount else -1*mount end),
		SUM(case when typea='1' then weight else -1*weight end),
		SUM(case when typea='1' then salemoney else -1*salemoney end),
		SUM(case when typea='1' then basemoney else -1*basemoney end),
		SUM(tranmoney2),SUM(wcost),
		SUM(case when typea='1' then ROUND(salemoney*days*0.0004,0) else -1*ROUND(salemoney*days*0.0004,0)end)--利息
	from @tmp group by salesno,grp,productno
	
	--5:中類分析->將gno=0的資料以中類合併
	if(CHARINDEX('5',@t_sel)>0)
	begin
		insert into @tmp(gno,grp,salesno,mount,weight,salemoney,basemoney,tranmoney2,wcost,interest)
		select '8',grp,salesno,SUM(mount),SUM(weight),SUM(salemoney),SUM(salemoney),SUM(tranmoney2),SUM(wcost),SUM(interest)from @tmp where gno='0' group by grp,salesno
	end
	
	if(CHARINDEX('3',@t_sel)>0)
	begin
		--合計
		insert into @tmp(gno,salesno,grp,productno,mount,weight,salemoney)
		select '3',salesno,'ZZZ','ZZZZZZ',SUM(mount),SUM(weight),SUM(salemoney)
		from @tmp where gno='0' 
		group by salesno
	end
	if(CHARINDEX('4',@t_sel)>0)
	begin	
		--合計
		insert into @tmp(gno,ranks,salesno,grp,productno,mount,weight,salemoney)
		select '4',RANK()over(order by SUM(salemoney) desc),salesno,'ZZZ','ZZZZZZ',SUM(mount),SUM(weight),SUM(salemoney)
		from @tmp where gno='0' 
		group by salesno				
		
		delete @tmp where gno='3'		
	end	
end
else
begin
	insert into @tmp(gno,grp,productno,mount,weight,salemoney,basemoney,tranmoney2,wcost,interest)	  
	select 
		'0',grp,productno,
		SUM(case when typea='1' then mount else -1*mount end),
		SUM(case when typea='1' then weight else -1*weight end),
		SUM(case when typea='1' then salemoney else -1*salemoney end),
		SUM(case when typea='1' then basemoney else -1*basemoney end),
		SUM(tranmoney2),SUM(wcost),
		SUM(case when typea='1' then ROUND(salemoney*days*0.0004,0) else -1*ROUND(salemoney*days*0.0004,0)end)--利息
	from @tmp group by grp,productno
	
	--5:中類分析->將gno=0的資料以中類合併
	if(CHARINDEX('5',@t_sel)>0)
	begin
		insert into @tmp(gno,grp,mount,weight,salemoney,basemoney,tranmoney2,wcost,interest)
		select '8',grp,SUM(mount),SUM(weight),SUM(salemoney),SUM(salemoney),SUM(tranmoney2),SUM(wcost),SUM(interest)from @tmp where gno='0' group by grp
	end
	
	--合計
	insert into @tmp(gno,salesno,grp,productno,mount,weight,salemoney)
	select '2','ZZZZ','ZZZ','ZZZZZZ',SUM(mount),SUM(weight),SUM(salemoney)from @tmp where gno='0'
end

--毛利=出貨金額-基價金額-補運費-加工費-利息
update @tmp set profit = salemoney-basemoney-tranmoney2-wcost-interest 

--毛利率=毛利/出貨金額
update @tmp set rate = case when salemoney=0 then 0 else profit/salemoney*100 end

--2:客戶別統計
if(CHARINDEX('2',@t_sel)>0)
begin
	declare @grp nvarchar(10)
	declare @xgrp nvarchar(10)=''
	declare @productno nvarchar(30)
	
	declare cursor_table cursor for 
	select grp,productno from @tmp group by grp,productno
	open cursor_table 
	fetch next from cursor_table 
	into @grp,@productno
	while(@@FETCH_STATUS <> -1) 
	begin	
		--5:中類分析->將gno=0的資料以中類合併	
		if(CHARINDEX('5',@t_sel)>0 and @grp!=@xgrp)
		begin
			insert into @tmp(gno,salesno,custno,grp,mount,salemoney)
			select 
				'1',salesno,custno,grp,
				SUM(case when typea='1' then mount else -1*mount end),
				SUM(case when typea='1' then salemoney else -1*salemoney end)		
			from @tmp
			where gno='9' and (grp=@grp)
			group by salesno,custno,grp
		end
		if(CHARINDEX('5',@t_sel)=0)
		begin
			insert into @tmp(gno,salesno,custno,grp,productno,mount,salemoney)
			select 
				'1',salesno,custno,grp,productno,
				SUM(case when typea='1' then mount else -1*mount end),
				SUM(case when typea='1' then salemoney else -1*salemoney end)	
			from @tmp
			where gno='9' and (productno=@productno)
			group by salesno,custno,grp,productno
		end
		
		set @xgrp=@grp
		
		fetch next from cursor_table
		into @grp,@productno
	end
	close cursor_table
	deallocate cursor_table
end

delete @tmp where gno='9'

--名次(for 4:業務排行榜)
update @tmp set ranks=b.ranks
from @tmp a
left join (select salesno,ranks from @tmp where gno='4')b on a.salesno=b.salesno

insert into @tmp(gno,ranks,rankd,salesno)
select '5',ranks,'第'+CAST(ranks as nvarchar)+'名：',salesno from @tmp where gno='4'

--5:中類分析
if(CHARINDEX('5',@t_sel)>0)
begin
	delete @tmp where gno='0'
	update @tmp set gno ='0' where gno='8'
	update @tmp set productno = grp
end

select
	a.*,
	dbo.getComma(mount,0) mnt,
	dbo.getComma(weight,0) wei, 
	dbo.getComma(salemoney,0) smny,
	dbo.getComma(basemoney,0) bmny,
	dbo.getComma(tranmoney2,0) tmny2,
	dbo.getComma(wcost,0) wcst,
	dbo.getComma(interest,0) intt,
	dbo.getComma(a.profit,0) pft,
	b.product,'＜'+a.custno+'＞' cno,c.nick,
	case when CHARINDEX('3',@t_sel)>0 and CHARINDEX('4',@t_sel)=0 then '業務：'+a.salesno+'　'+isnull(d.namea,'') else '' end sales,
	rankd+a.salesno+'　'+isnull(d.namea,'') [rank]
from @tmp a
left join ucc b on a.productno=b.noa
left join cust c on a.custno=c.noa
left join sss d on a.salesno=d.noa 
order by ranks,case when CHARINDEX('3',@t_sel)>0 or CHARINDEX('4',@t_sel)>0 then a.salesno else productno end,productno,custno;
--***********************************************************************************************
z_uccfe6:--z_uccfe6
	declare @t_bproductno nvarchar(50)
	declare @t_eproductno nvarchar(50)
	declare @t_bstoreno nvarchar(50)
	declare @t_estoreno nvarchar(50)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	set @t_bproductno = case when '#non'=[1] then '' else [1] end
	set @t_eproductno = case when '#non'=[2] then char(255) else [2] end
	set @t_bstoreno = case when '#non'=[3] then '' else [3] end
	set @t_estoreno = case when '#non'=[4] then char(255) else [4] end
	set @t_bdate = case when '#non'=[6] then '' else [6] end
	set @t_edate = case when '#non'=[7] then char(255) else [7] end
	declare @t_project nvarchar(20) = case when '#non'='[10]' then '' else '[10]' end
	declare @qhref_acomp nvarchar(10) =''
-------------------------------------------------------------------------------------------------------
if(@t_project='fe')
	set @qhref_acomp='fe'
if(@t_project='yc')
	set @qhref_acomp='_yc'
-------------------------------------------------

	declare @tmp table(
		gno nvarchar(1),
		recno int,
		storeno nvarchar(50),
		stores nvarchar(50),
		productno nvarchar(30),
		xproduct nvarchar(200),
		datea nvarchar(10),
		typea nvarchar(10),
		typec nvarchar(10),
		noa nvarchar(20),
		comp nvarchar(40),
		unit nvarchar(10),
		mount float,
		weight float,
		qhref nvarchar(50),
		totmount float,
		totweight float,
		ucctype nvarchar(15)
	)
	
	insert into @tmp
	select
		'0' gno, ROW_NUMBER()over(order by R1.productno,R1.storeno,R1.datea,R1.typea)as recno,R1.*, 0 totmount, 0 totweight,''
	from(
		select isnull(storeno,'')storeno ,store,productno,product xproduct,isnull(datea,'') datea,'01' typea,'盤點調整' typec, 
		       noa,'' comp, unit, mount mount, weight weight,'ucce?noa=$noa?'+accy qhref
		from view_ucces
		where  productno BETWEEN @t_bproductno AND @t_eproductno and datea<=@t_edate and isnull(storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(b.datea,'') datea,case a.typea when '2' then 'A0' else '10' end typea,case a.typea when '2' then '進貨退回' else '進貨' end typec,
		       b.noa, isNull(a.tgg,'') comp, b.unit, b.mount, b.weight,'rc2'+@qhref_acomp+'?noa=$noa?'+b.accy qhref
		from view_rc2s b left join view_rc2 a on a.noa=b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and b.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(b.datea,'') datea,case a.typea when '2' then '11' else 'B0' end typea,case a.typea when '2' then '出貨退回' else '出貨' end typec,
		       b.noa, isNull(a.comp,'') comp, b.unit,(case when isnull(b.gmount,0)!=0 then b.gmount else b.mount end)
		       ,(case when isnull(b.gweight,0)!=0 then b.gweight else b.weight end),'vcc'+@qhref_acomp+'?noa=$noa?'+b.accy qhref
		from view_vccs b left join view_vcc a on a.noa=b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and b.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(a.storeno,''),a.store,b.productno,b.product xproduct,isnull(b.datea,'') datea, '12' typea, '入庫' typec,
		       b.noa,  isNull(a.comp,'') comp, b.unit, b.mount, b.weight,'ina'+@qhref_acomp+'?noa=$noa?'+b.accy qhref
		from view_inas b left join view_ina a on b.noa=a.noa 
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and b.datea<=@t_edate and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(a.storeno,''),a.store,b.productno,b.product xproduct,isnull(b.datea,'') datea, 'C0' typea, '領料' typec,
		       b.noa, isNull(a.comp,'') comp, b.unit, b.mount, b.weight,'getfe?noa=$noa?'+b.accy qhref
		from view_gets b left join view_get a on a.noa=b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and b.datea<=@t_edate and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(a.datea,'') datea, 'C0' typea, '製品領料' typec,
		       a.noa, isNull(a.station,'') comp, b.unit, (case when a.typea='2' then -1 else 1 end)*b.mount, (case when a.typea='2' then -1 else 1 end)*b.weight,'worka?noa=$noa?'+b.accy qhref
		from view_workas b left join view_worka a on a.noa = b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(a.datea,'') datea, 'C0' typea, '委製領料' typec,
		       a.noa, isNull(a.tgg,'') comp, b.unit, (case when a.typea='2' then -1 else 1 end)*b.mount, (case when a.typea='2' then -1 else 1 end)*b.weight,'workc?noa=$noa?'+b.accy qhref
		from view_workcs b left join view_workc a on a.noa = b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(a.datea,'') datea, '10' typea, '製品入庫' typec,
		       a.noa, isNull(a.station,'') comp, b.unit, b.mount, b.weight,'workb?noa=$noa?'+b.accy qhref
		from view_workbs b left join view_workb a on a.noa = b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(a.datea,'') datea, '10' typea, '委製入庫' typec,
		       a.noa, isNull(a.tgg,'') comp, b.unit, b.mount+b.inmount-b.outmount, b.weight,'workd?noa=$noa?'+b.accy qhref
		from view_workds b left join view_workd a on a.noa = b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		
		union all
		select isnull(a.storeinno,''),a.storein,b.productno,b.product xproduct,isnull(a.datea,'') datea, '10' typea
		,case when a.typea='1' then '廠調入庫+' when a.typea='2' then '委入入庫' when a.typea='3' then '委出入庫' 
				when a.typea='4' then '客借入庫' when a.typea='5' then '客歸入庫' when a.typea='6' then '委加入庫' else '' end typec
		,a.noa, isNull(a.tgg,'') comp, b.unit, b.mount, b.weight,'cng?noa=$noa?'+b.accy qhref
		from view_cngs b left join view_cng a on a.noa = b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(a.storeinno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(a.storeno,''),a.store,b.productno,b.product xproduct,isnull(a.datea,'') datea, 'C0' typea
		,case when a.typea='1' then '廠調出庫' when a.typea='2' then '委入出庫' when a.typea='3' then '委出出庫' 
				when a.typea='4' then '客借出庫' when a.typea='5' then '客歸出庫' when a.typea='6' then '委加出庫' else '' end typec
		,a.noa, isNull(a.tgg,'') comp, b.unit, b.mount, b.weight,'cng?noa=$noa?'+b.accy qhref
		from view_cngs b left join view_cng a on a.noa = b.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
		-----------------------------------
		union all
		select isnull(b.storeno,''),d.store,b.productno,b.product xproduct,isnull(a.datea,'') datea, '10' typea, '裁剪入庫' typec,
		       a.noa, isNull(a.tgg,'') comp, c.unit, b.mount, b.weight,'cut?noa=$noa?'+b.accy qhref
		from view_cuts b left join view_cut a on a.noa = b.noa left join view_ucaucc c on b.productno=c.noa
		left join store d on b.storeno=d.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(a.storeno,''),a.store,a.productno,a.product xproduct,isnull(a.datea,'') datea, 'C0' typea, '裁剪領料' typec,
		       a.noa, isNull(a.tgg,'') comp, c.unit, a.mount, a.oweight,'cut?noa=$noa?'+a.accy qhref
		from view_cut a left join view_ucaucc c on a.productno=c.noa
		where a.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(b.datea,'') datea, '10' typea, '加工入庫' typec,
		       a.noa, isNull(a.tgg,'') comp, c.unit, b.mount, b.weight,'cub'+@qhref_acomp+'?noa=$noa?'+b.accy qhref
		from view_cubu b left join view_cub a on a.noa = b.noa left join view_ucaucc c on b.productno=c.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(b.datea,'') datea, 'C0' typea, '加工領料' typec,
		       a.noa, isNull(a.tgg,'') comp, c.unit, b.gmount, b.gweight,'cub'+@qhref_acomp+'?noa=$noa?'+b.accy qhref
		from view_cubt b left join view_cub a on a.noa = b.noa left join view_ucaucc c on b.productno=c.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		----------
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(b.datea,'') datea, '10' typea, '委外借入' typec,
		       a.noa, isNull(a.tgg,'') comp, c.unit, b.mount, b.weight,'vcf'+@qhref_acomp+'?noa=$noa?' qhref
		from vcfs b left join vcf a on a.noa = b.noa left join view_ucaucc c on b.productno=c.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		union all
		select isnull(b.storeno,''),b.store,b.productno,b.product xproduct,isnull(b.datea,'') datea, 'C0' typea, '委外借出' typec,
		       a.noa, isNull(a.tgg,'') comp, c.unit, b.mount, b.weight,'vcf'+@qhref_acomp+'?noa=$noa?' qhref
		from vcft b left join vcf a on a.noa = b.noa left join view_ucaucc c on b.productno=c.noa
		where b.productno BETWEEN @t_bproductno AND @t_eproductno and a.datea<=@t_edate and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
		) as R1
		
	--*****************************************************************************************	
	
	declare @result table(
		gno nvarchar(1),
		recno int IDENTITY(1,1),
		storeno nvarchar(50),
		stores nvarchar(50),
		productno nvarchar(30),
		xproduct nvarchar(40),
		datea nvarchar(10),
		typea nvarchar(10),
		typec nvarchar(10),
		noa nvarchar(20),
		comp nvarchar(40),
		unit nvarchar(10),
		mount float,
		weight float,
		qhref nvarchar(50),
		totmount float,
		totweight float,
		ucctype nvarchar(15)
		primary key (productno,storeno,recno)
	)
	
	declare @recno int
	declare @productno nvarchar(30)
	declare @storeno nvarchar(30)
	declare @typea nvarchar(10)
	declare @datea nvarchar(10)
	declare @mount float
	declare @weight float
	
	declare @t_productno nvarchar(30)
	declare @t_storeno nvarchar(30)
	declare @t_mount float
	declare @t_weight float
	declare @t_totmount float
	declare @t_totweight float
	declare @tt_totmount float
	declare @tt_totweight float
	declare @pt_totmount float
	declare @pt_totweight float
	
	set @t_productno = '##########'
	set @t_storeno = '##########'
	set @t_mount = 0
	set @t_weight = 0
	set @t_totmount = 0
	set @t_totweight = 0
	set @tt_totmount = 0
	set @tt_totweight = 0
	set @pt_totmount = 0
	set @pt_totweight = 0
	
	declare cursor_table cursor for
	select recno,productno,storeno,typea,datea,mount,weight from @tmp order by productno,storeno,recno
	open cursor_table
	fetch next from cursor_table
	into @recno,@productno,@storeno,@typea,@datea,@mount,@weight
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_productno!=@productno and @t_productno!='##########'
		begin
			if not(@t_totmount=0 and @t_totweight=0) or (select count(*) from @result where storeno=@t_storeno and productno=@t_productno)>0
			begin
				insert into @result
				select '0' gno,@t_storeno,(select top 1 store from store where noa=@t_storeno),@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,'' datea,'02' typea,'前期' typec, 
				'' noa,'' comp, '' unit, null mount, null weight,'', @pt_totmount totmount, @pt_totweight totweight,''
			
				insert into @result
				select '1' gno,@t_storeno,(select top 1 store from store where noa=@t_storeno),@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,CHAR(255) datea,'zz' typea,'小計' typec, 
				'' noa,'' comp, '' unit, null mount, null weight,'', @t_totmount totmount, @t_totweight totweight,''
				
			end
			
				set @tt_totmount = @tt_totmount+@t_totmount
				set @tt_totweight = @tt_totweight+@t_totweight
				
				if(select count(*) from @result where productno=@t_productno)>0
				begin
					insert into @result
					select '2' gno,char(255),'',@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,CHAR(255) datea,'zz' typea,'總計' typec, 
					'' noa,'' comp, '' unit, null mount, null weight,'', @tt_totmount totmount, @tt_totweight totweight,''
				end
				   
			set @t_mount = 0
			set @t_weight = 0
			set @t_totmount = 0
			set @t_totweight = 0
			set @tt_totmount = 0
			set @tt_totweight = 0
			set @pt_totmount = 0
			set @pt_totweight = 0
		end
		else if @t_storeno!=@storeno and @t_storeno!='##########'
		begin
		
			if not(@t_totmount=0 and @t_totweight=0 ) or (select count(*) from @result where storeno=@t_storeno and productno=@t_productno)>0
			begin
				insert into @result
				select '0' gno,@t_storeno,(select top 1 store from store where noa=@t_storeno),@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,'' datea,'02' typea,'前期' typec, 
				'' noa,'' comp, '' unit, null mount, null weight,'', @pt_totmount totmount, @pt_totweight totweight,''
					  
				insert into @result
				select '1' gno,@t_storeno,(select top 1 store from store where noa=@t_storeno),@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,CHAR(255) datea,'zz' typea,'小計' typec, 
				'' noa,'' comp, '' unit, null mount, null weight,'', @t_totmount totmount, @t_totweight totweight,''
			end
			
			set @tt_totmount = @tt_totmount+@t_totmount
			set @tt_totweight = @tt_totweight+@t_totweight
			
			set @t_mount = 0
			set @t_weight = 0
			set @t_totmount = 0
			set @t_totweight = 0
			set @pt_totmount = 0
			set @pt_totweight = 0
		end

		if  @datea between @t_bdate and @t_edate
		begin
			set @t_mount =
				case 
				when @typea='01' or @typea='ZZ' then @mount
				when @typea='10' or @typea='11' or @typea='12' then @t_totmount + @mount
				when @typea='A0' or @typea='B0' or @typea='C0' then @t_totmount - @mount
				end
			set @t_weight =
				case 
				when @typea='01' or @typea='ZZ' then @weight
				when @typea='10' or @typea='11' or @typea='12' then @t_totweight + @weight
				when @typea='A0' or @typea='B0' or @typea='C0' then @t_totweight - @weight
				end
				
			insert @result
			select gno,storeno,stores,productno,xproduct,datea,typea,typec,noa,comp,unit,mount,weight,qhref,@t_mount,@t_weight,ucctype 
			from @tmp where recno=@recno	
		end
		else
		begin
			set @pt_totmount =
				case 
				when @typea='01' or @typea='ZZ' then @mount
				when @typea='10' or @typea='11' or @typea='12' then @t_totmount + @mount
				when @typea='A0' or @typea='B0' or @typea='C0' then @t_totmount - @mount
				end
			set @pt_totweight =
				case 
				when @typea='01' or @typea='ZZ' then @weight
				when @typea='10' or @typea='11' or @typea='12' then @t_totweight + @weight
				when @typea='A0' or @typea='B0' or @typea='C0' then @t_totweight - @weight
				end
		end
		
		set @t_totmount =
			case 
			when @typea='01' or @typea='ZZ' then @mount
			when @typea='10' or @typea='11' or @typea='12' then @t_totmount + @mount
			when @typea='A0' or @typea='B0' or @typea='C0' then @t_totmount - @mount
			end
		set @t_totweight =
			case 
			when @typea='01' or @typea='ZZ' then @weight
			when @typea='10' or @typea='11' or @typea='12' then @t_totweight + @weight
			when @typea='A0' or @typea='B0' or @typea='C0' then @t_totweight - @weight
			end
		
		set @t_productno = @productno
		set @t_storeno = @storeno

		fetch next from cursor_table
		into @recno,@productno,@storeno,@typea,@datea,@mount,@weight
	end
	close cursor_table
	deallocate cursor_table
	
	--最後一筆處理---------------------------------------------------------------------
	if not(@t_totmount=0 and @t_totweight=0) or (select count(*) from @result where storeno=@t_storeno and productno=@t_productno)>0
	begin
		insert into @result
		select '0' gno,@t_storeno,(select top 1 store from store where noa=@t_storeno),@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,'' datea,'02' typea,'前期' typec, 
		'' noa,'' comp, '' unit, null mount, null weight,'', @pt_totmount totmount, @pt_totweight totweight,''
		
		insert into @result
		select '1' gno,@t_storeno,(select top 1 store from store where noa=@t_storeno),@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,CHAR(255) datea,'zz' typea,'小計' typec, 
		'' noa,'' comp, '' unit, null mount, null weight,'', @t_totmount totmount, @t_totweight totweight,''
		
	end
	
	set @tt_totmount = @tt_totmount+@t_totmount
	set @tt_totweight = @tt_totweight+@t_totweight
	
	if(select count(*) from @result where productno=@t_productno)>0
	begin
		insert into @result
		select '2' gno,char(255),'',@t_productno,(select top 1 product from view_ucaucc where noa=@t_productno) xproduct,CHAR(255) datea,'zz' typea,'總計' typec, 
		'' noa,'' comp, '' unit, null mount, null weight,'', @tt_totmount totmount, @tt_totweight totweight,''
	end
	
	set @t_mount = 0
	set @t_weight = 0
	set @t_totmount = 0
	set @t_totweight = 0
	set @tt_totmount = 0
	set @tt_totweight = 0
	set @pt_totmount = 0
	set @pt_totweight = 0
	--------------------------------------------------------------------------------------------
	declare @ucctype nvarchar(15)
	declare cursor_table cursor for
	select noa,typea from ucc order by noa
	open cursor_table
	fetch next from cursor_table
	into @t_productno,@ucctype
	while(@@FETCH_STATUS <> -1)
	begin
		update @result set ucctype = @ucctype where productno=@t_productno
		fetch next from cursor_table
		into @t_productno,@ucctype
	end
	close cursor_table
	deallocate cursor_table
	
	
	delete @result where productno in (select noa from uca)
	
	--*****************************************************************************************	
	
	select gno,recno,storeno,case when ISNULL(stores,'')='' then storeno else left(stores,7) end stores,productno
	,replace(xproduct,'~#$',char(39)) xproduct,datea,typea,typec,noa,left(comp,11) comp,unit,ucctype,qhref
	,dbo.getComma((case when typea='A0' or typea='B0' or typea='C0' then -1 else 1 end)*round(mount,0),[11])	mount
	,dbo.getComma((case when typea='A0' or typea='B0' or typea='C0' then -1 else 1 end)*weight,[12]) weight
	,dbo.getComma(totmount,[11])	totmount
	,dbo.getComma(totweight,[12])	totweight
	from @result order by productno,storeno, gno,datea, recno;
--*****************************************************************************
z_uccfe5:--z_uccfe5  批號庫存表
	declare @t_bdate nvarchar(20) = '103/01/01'  --103/01/01後 的資料才看
	declare @t_edate nvarchar(20) = case when '#non'=[5] then char(255) else [5] end
	declare @t_bproductno nvarchar(30) = case when '#non'=[1] then '' else [1] end
	declare @t_eproductno nvarchar(30) = case when '#non'=[2] then char(255) else [2] end

	declare @tmp table(
		gno nvarchar(10),
		uno nvarchar(50),
		productno nvarchar(30),
		product nvarchar(100),
		mount float,
		[weight] float
	)
	
	insert into @tmp(uno,productno,product,mount,[weight])
	execute dbo.stkucc3 @t_bdate,@t_edate
	
	delete @tmp where not isnull(productno,'') between @t_bproductno and @t_eproductno
	update @tmp set gno='1'
	
	insert into @tmp(gno,productno,mount,[weight])
	select '2',CHAR(255),SUM(ISNULL(mount,0)),SUM(ISNULL([weight],0))
	from @tmp
	
	select ROW_NUMBER()over(order by gno,productno,uno) rr
		,productno a01
		,replace(product,'~#$',char(39)) a02
		,uno a03
		,dbo.getComma(mount,0) a04
		,dbo.getComma([weight],0) a05 
		,* 
	from @tmp 
	order by gno,productno,uno;

z_uccfe4:--z_uccfe4
	SET QUOTED_IDENTIFIER OFF
	declare @t_bproductno nvarchar(30) = case when '#non'=[1] then '' else [1] end
	declare @t_eproductno nvarchar(30) = case when '#non'=[2] then char(255) else [2] end
	--declare @t_bstoreno nvarchar(20) = case when '#non'=[3] then '' else [3] end
	--declare @t_estoreno nvarchar(20) = case when '#non'=[4] then char(255) else [4] end
	--declare @t_enddate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	--declare @t_bdate nvarchar(20) = case when '#non'=[6] then '' else [6] end
	--declare @t_edate nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
	--declare @t_option01 nvarchar(max) = case when '#non'=[8] then '' else [8] end
	-----------------------------------------------------------------------------------------------------
	select *
		,'1' gno 
		,ROW_NUMBER()over(order by noa) rr
		,"uccfe?noa=\'"+noa+"\' and "+cast(ROW_NUMBER()over(order by noa) as nvarchar)+"=$rr?" ghref
		,noa a01
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+replace(product,'~#$',char(39))+'</a>' a02
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+[unit]+'</a>' a03
		,dbo.getComma(uweight,2) a04
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+case when len(ISNULL(tgg,''))=0 then tggno else tgg end+'</a>' a05
		,dbo.getComma(inprice,3) a06
		,dbo.getComma(saleprice,3) a07
		,dbo.getComma(safemount,0) a08
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+[styleno]+'</a>' a09
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+[memo]+'</a>' a10
	from ucc
	where noa between @t_bproductno and @t_eproductno
	order by noa;

z_uccfe3:--z_uccfe3 
	SET QUOTED_IDENTIFIER OFF
	declare @t_bproductno nvarchar(30) = case when '#non'=[1] then '' else [1] end
	declare @t_eproductno nvarchar(30) = case when '#non'=[2] then char(255) else [2] end
	declare @t_bstoreno nvarchar(20) = case when '#non'=[3] then '' else [3] end
	declare @t_estoreno nvarchar(20) = case when '#non'=[4] then char(255) else [4] end
	declare @t_enddate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	--declare @t_bdate nvarchar(20) = case when '#non'=[6] then '' else [6] end
	--declare @t_edate nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
	--declare @t_option01 nvarchar(max) = case when '#non'=[8] then '' else [8] end
	declare @t_showcarton nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_project nvarchar(20) = case when '#non'='[10]' then '' else '[10]' end
	declare @t_showprice nvarchar(20) = case when '#non'=[14] then '0' else [14] end
	------------------------------------------------------------------------------------
	--前期
	declare @tmpa table(
		productno nvarchar(30),
		storeno nvarchar(30),
		mount float,
		[weight] float
	)
	insert into @tmpa
	execute dbo.stkucc2 @t_enddate,@t_bstoreno,@t_estoreno,@t_bproductno,@t_eproductno 
	------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_uccfe3')is not null
	BEGIN
		drop table #z_uccfe3
	END
	create table #z_uccfe3(
		gno nvarchar(10),
		pno nvarchar(10),
		recno int,
		pp int,
		qq int,
		storeno nvarchar(30),
		store nvarchar(50),
		productno nvarchar(30),
		product nvarchar(100),
		unit nvarchar(30),
		mount float,
		[weight] float,
		price float,
		[money] float
	)
	insert into #z_uccfe3(gno,pno,recno,storeno,productno,mount,[weight])
	select '1','1',ROW_NUMBER()over(partition by storeno order by productno)
		,storeno,productno,mount,[weight]
	from @tmpa
	where not(mount=0 and [weight]=0)
	and productno between @t_bproductno and @t_eproductno
	and storeno between @t_bstoreno and @t_estoreno
	
	update #z_uccfe3 set product=ISNULL(b.product,''),store=ISNULL(c.store,''),unit=isnull(b.unit,'')
	from #z_uccfe3 a
	left join ucc b on a.productno=b.noa
	left join store c on a.storeno=c.noa
	-------------------------------------------------------------------------------------------
	if(@t_project='FE')
	begin
		update #z_uccfe3 set price = ISNULL(b.sprice,0),[money]=ISNULL(a.mount*b.sprice,0)
		from #z_uccfe3 a
		outer apply(select top 1 y.sprice
			from uccp x
			left join uccps y on x.noa=y.noa
			where y.productno=a.productno and x.datea<=@t_enddate
			order by x.datea desc) b
	end
	else
	begin
		update #z_uccfe3 set price = ISNULL(b.price,0)
			,[money]=ISNULL(case when a.unit='KG' or a.unit='公斤' or len(isnull(a.unit,''))=0 then a.[weight] else a.mount end*b.price,0)
		from #z_uccfe3 a
		outer apply(select price from view_costs where mon=LEFT(@t_enddate,6) and productno=a.productno ) b	
	end
		
	---------------------------------------------------------------------------------------------
	insert into #z_uccfe3(gno,pno,recno,storeno,store,mount,[weight],[money])
	select '2','2',MAX(recno)+1,storeno,store,sum(mount),sum([weight]),sum(isnull([money],0))
	from #z_uccfe3
	where gno = '1'
	group by storeno,store	
	---------------------------------------------------------------------------------------------
	declare @t_pageline int = 40
	declare @storeno nvarchar(20)
	declare @n int
	
	update #z_uccfe3 set pp = floor((a.recno-1)/@t_pageline) + 1
		,qq = floor((b.recno-1)/@t_pageline) + 1
	from #z_uccfe3 a
	left join (select * from #z_uccfe3 where gno='2')b on a.storeno=b.storeno 
	
	declare cursor_table cursor for
	select storeno,count(1) from #z_uccfe3 group by storeno
	open cursor_table
	fetch next from cursor_table
	into @storeno,@n
	while(@@FETCH_STATUS <> -1)
	begin
		while @n%@t_pageline!=0
		begin
			insert into #z_uccfe3(gno,pno,recno,storeno)
			values('3','3',0,@storeno)
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @storeno,@n
	end
	close cursor_table
	deallocate cursor_table
	
	if(@t_showprice='0')
	begin
		update #z_uccfe3 set price=null,money=null
	end
	
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		recno int,
		pp int,
		qq int,
		storeno nvarchar(30),
		store nvarchar(50),
		productno nvarchar(30),
		product nvarchar(100),
		unit nvarchar(30),
		mount decimal(20,4),
		[weight] decimal(20,4),
		price decimal(20,4),
		[money] decimal(20,4),
		carton decimal(20,4)
	)
	
	if (@t_showcarton!='1')
	begin
		insert @tmp
		select a.*,null
		from #z_uccfe3 a 
		
		update @tmp set gno=CAST(CAST(gno as int )+1 as nvarchar(10))
		
		--插入表頭分頁
		insert @tmp(gno,pp,qq,storeno,recno,pno)
		select '1',pp,MAX(qq),storeno,MIN(recno)-1,MIN(pno)
		from @tmp where gno!='4' group by pp,storeno
		
		insert @tmp(gno,pp,qq,storeno,recno,pno)
		select '5',pp,MAX(qq),storeno,MAX(recno),MAX(pno)
		from @tmp where gno!='1' and gno!='4' group by pp,storeno
	
		update @tmp set pp=null,qq=null,recno=0,pno='4' where gno='5' and pp=qq
	end
	else
	begin
		insert @tmp
		select a.*,CEILING(a.mount/NULLIF(b.stdmount,0))
		from #z_uccfe3 a left join ucc b on a.productno = b.noa order by productno,recno
		
		update @tmp set gno=CAST(CAST(gno as int )+6 as nvarchar(10))
		
		--插入表頭分頁
		insert @tmp(gno,pp,qq,storeno,recno,pno)
		select '6',pp,MAX(qq),storeno,MIN(recno)-1,MIN(pno)
		from @tmp where gno!='9' group by pp,storeno
		
		insert @tmp(gno,pp,qq,storeno,recno,pno)
		select '10',pp,MAX(qq),storeno,MAX(recno),MAX(pno)
		from @tmp where gno!='1' and gno!='9' group by pp,storeno
	
		update @tmp set pp=null,qq=null,recno=0,pno='9' where gno='10' and pp=qq
	end
	
	select * 
		,recno rr
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">倉庫：'+storeno +'&nbsp'+char(59)+store+'</a>' title
		,storeno a01
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+store+'</a>' a02
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+productno+'</a>' a03
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+replace(product,'~#$',char(39))+'</a>' a04
		,dbo.getComma(mount,0) a05
		,dbo.getComma([weight],2) a06
		,dbo.getComma(price,2) a07
		,dbo.getComma([money],0) a08
	from @tmp order by storeno,pno,recno,pp
	drop table #z_uccfe3
	
	IF OBJECT_ID('tempdb..#z_uccfe3')is not null
	BEGIN
		drop table #z_uccfe3
	END
	;
--***********************************************************************************************
z_uccfe2:--z_uccfe2 
	SET QUOTED_IDENTIFIER OFF
	declare @t_bproductno nvarchar(30) = case when '#non'=[1] then '' else [1] end
	declare @t_eproductno nvarchar(30) = case when '#non'=[2] then char(255) else [2] end
	declare @t_bstoreno nvarchar(20) = case when '#non'=[3] then '' else [3] end
	declare @t_estoreno nvarchar(20) = case when '#non'=[4] then char(255) else [4] end
	--declare @t_enddate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	declare @t_bdate nvarchar(20) = case when '#non'=[6] then '' else [6] end
	declare @t_edate nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
	--declare @t_option01 nvarchar(max) = case when '#non'=[8] then '' else [8] end
	declare @t_project nvarchar(20) = case when '#non'='[10]' then '' else '[10]' end
	declare @qhref_acomp nvarchar(10) =''
	-------------------------------------------------------------------------------------------------------
	if(@t_project='fe')
		set @qhref_acomp='fe'
	if(@t_project='yc')
		set @qhref_acomp='_yc'
	-----------------------------------------------------------------------------------------------------
	declare @bbdate nvarchar(20) = dbo.AD2ChineseEraName(dateadd(DD,-1,dbo.ChineseEraName2AD(@t_bdate)))
	
	--前期
	declare @tmpa table(
		productno nvarchar(30),
		storeno nvarchar(30),
		mount float,
		[weight] float
	)
	insert into @tmpa
	execute dbo.stkucc2 @bbdate,@t_bstoreno,@t_estoreno,@t_bproductno,@t_eproductno
	-----------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_uccfe2')is not null
	BEGIN
		drop table #z_uccfe2
	END
	create table #z_uccfe2(
		gno nvarchar(10),
		pno nvarchar(20),
		recno int,
		productno nvarchar(30),
		product nvarchar(100),
		datea nvarchar(20),
		storeno nvarchar(30),
		store nvarchar(50),
		[action] nvarchar(20),
		n int,
		mount float,
		[weight] float,
		totmount float,
		totweight float,
		accy nvarchar(10),
		tablea nvarchar(20),
		noa nvarchar(20),
		noq nvarchar(10),
	)
	create index product on #z_uccfe2(productno)
	create index noa on #z_uccfe2(accy,tablea,noa,noq)

	insert into #z_uccfe2(gno,pno,productno,storeno,datea,[action],n,mount,[weight]
		,accy,tablea,noa,noq)
	select '1','01',productno,storeno,@bbdate,'前期',1,mount,[weight]
		,'','stkucc',productno,''
	from @tmpa
	where productno between @t_bproductno and @t_eproductno
	and storeno between @t_bstoreno and @t_estoreno
	and not(mount=0 and [weight]=0)
	
	update #z_uccfe2 set product=ISNULL(b.product,''),store=ISNULL(c.store,'')
	from #z_uccfe2 a
	left join ucc b on a.productno=b.noa
	left join store c on a.storeno=c.noa
	--本期
	------------UCCE
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','02',b.productno,b.product,a.datea
		,'盤點'
		,1
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,a.accy,'ucce',a.noa,b.noq
	from view_ucce a
	left join view_ucces b on a.accy=b.accy and a.noa=b.noa
	where len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	---------------------------------------------------------------------------------------------
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','03',b.productno,b.product,a.datea
		,case a.typea when '1' then '進貨' else '進退' end
		,case a.typea when '1' then 1 else -1 end
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,a.accy,'rc2'+@qhref_acomp,a.noa,b.noq
	from view_rc2 a
	left join view_rc2s b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','04',b.productno,b.product,a.datea
		,'入庫'
		,1
		,b.mount,b.[weight]
		,isnull(a.storeno,''),a.store
		,a.accy,'ina'+@qhref_acomp,a.noa,b.noq
	from view_ina a
	left join view_inas b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	--cng
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','05',b.productno,b.product,a.datea
		,'調出'
		,-1
		,b.mount,b.[weight]
		,isnull(a.storeno,''),a.store
		,a.accy,'cng'+@qhref_acomp+'_Ｘ',a.noa,b.noq
	from view_cng a
	left join view_cngs b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','06',b.productno,b.product,a.datea
		,'調入'
		,1
		,b.mount,b.[weight]
		,isnull(a.storeinno,''),a.store
		,a.accy,'cng'+@qhref_acomp+'_Ｚ',a.noa,b.noq
	from view_cng a
	left join view_cngs b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(a.storeinno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	--vcf
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','05',b.productno,b.product,b.datea
		,'委借出'
		,-1
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,'','vcf'+(case when @qhref_acomp='fe' then '' else @qhref_acomp end)+'_Ｚ',a.noa,b.noq
	from vcf a
	left join vcft b on a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and b.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','05',b.productno,b.product,b.datea
		,'委借入'
		,1
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,'','vcf'+(case when @qhref_acomp='fe' then '' else @qhref_acomp end)+'_Ｘ',a.noa,b.noq
	from vcf a
	left join vcfs b on a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and b.datea between @t_bdate and @t_edate
	----委入
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','07',b.productno,b.product,a.datea
		,case a.typea when '1' then '委入' else '委入退' end
		,case a.typea when '1' then 1 else -1 end
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,a.accy,'workd'+@qhref_acomp,a.noa,b.noq
	from view_workd a
	left join view_workds b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	--CUT
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','08',a.productno,a.product,a.datea
		,'裁剪領料'
		,-1
		,a.gmount,a.[gweight]
		,isnull(a.storeno,''),c.store
		,a.accy,'cut_Ｚ',a.noa,''
	from view_cut a
	left join store c on a.storeno=c.noa
	where  not(a.gmount=0 and a.[gweight]=0)
	and len(ISNULL(a.productno,''))>0
	and a.productno between @t_bproductno and @t_eproductno
	and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','09',b.productno,b.product,a.datea
		,'裁剪入庫'
		,1
		,b.mount,b.[weight]
		,isnull(b.storeno,''),c.store
		,a.accy,'cut_Ｘ',a.noa,b.noq
	from view_cut a
	left join view_cuts b on a.accy=b.accy and a.noa=b.noa
	left join store c on b.storeno=c.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	--cub
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','10',b.productno,b.product,a.datea
		,'派令領料'
		,-1
		,b.gmount,b.[gweight]
		,isnull(b.storeno,''),c.store
		,a.accy,'cub'+(case when @qhref_acomp='fe' then '' else @qhref_acomp end)+'_Ｚ',a.noa,b.noq
	from view_cub a
	left join view_cubt b on a.accy=b.accy and a.noa=b.noa
	left join store c on b.storeno=c.noa
	where  not(b.gmount=0 and b.[gweight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','11',b.productno,b.product,b.datea
		,'派令入庫'
		,1
		,b.mount,b.[weight]
		,isnull(b.storeno,''),c.store
		,a.accy,'cub'+(case when @qhref_acomp='fe' then '' else @qhref_acomp end)+'_Ｘ',a.noa,b.noq
	from view_cub a
	left join view_cubu b on a.accy=b.accy and a.noa=b.noa
	left join store c on b.storeno=c.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and b.datea between @t_bdate and @t_edate
	
	--委出
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','12',b.productno,b.product,a.datea
		,case a.typea when '1' then '委出' else '委出退' end
		,case a.typea when '1' then -1 else 1 end
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,a.accy,'workcfe',a.noa,b.noq
	from view_workc a
	left join view_workcs b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','13',b.productno,b.product,a.datea
		,'領料'
		,-1
		,b.mount,b.[weight]
		,isnull(a.storeno,''),a.store
		,a.accy,'getfe',a.noa,b.noq
	from view_get a
	left join view_gets b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(a.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','14',b.productno,b.product,a.datea
		,case a.typea when '1' then '出貨' else '出退' end
		,case a.typea when '1' then -1 else 1 end
		,case ISNULL(b.gmount,0) when 0 then isnull(b.mount,0) else b.gmount end
		,case ISNULL(b.gweight,0) when 0 then isnull(b.[weight],0) else b.gweight end
		,isnull(b.storeno,''),b.store
		,a.accy,'vcc'+@qhref_acomp,a.noa,b.noq
	from view_vcc a
	left join view_vccs b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0 and b.gmount=0 and b.[gweight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','15',b.productno,b.product,a.datea
		,case a.typea when '1' then '發料' else '退料' end
		,case a.typea when '1' then -1 else 1 end
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,a.accy,'worka',a.noa,b.noq
	from view_worka a
	left join view_workas b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	insert into #z_uccfe2(gno,pno,productno,product,datea,[action],n,mount,[weight],storeno,store
		,accy,tablea,noa,noq)
	select '2','16',b.productno,b.product,a.datea
		,'製品入庫'
		,1
		,b.mount,b.[weight]
		,isnull(b.storeno,''),b.store
		,a.accy,'workb',a.noa,b.noq
	from view_workb a
	left join view_workbs b on a.accy=b.accy and a.noa=b.noa
	where  not(b.mount=0 and b.[weight]=0)
	and len(ISNULL(b.productno,''))>0
	and b.productno between @t_bproductno and @t_eproductno
	and isnull(b.storeno,'') between @t_bstoreno and @t_estoreno
	and a.datea between @t_bdate and @t_edate
	
	--------------------------------------------------------------------------
	declare @productno nvarchar(30)
	declare @storeno nvarchar(30)
	declare @accy nvarchar(10)
	declare @tablea nvarchar(20)
	declare @noa nvarchar(20)
	declare @noq nvarchar(10)
	declare @n int
	declare @mount float
	declare @weight float
	declare @totmount float
	declare @totweight float	
	declare @recno int
	declare @date nvarchar(20)
	declare @curdate nvarchar(20)
	
	declare cursor_table cursor for
	select productno,storeno from #z_uccfe2 group by productno,storeno
	open cursor_table
	fetch next from cursor_table
	into @productno,@storeno
	while(@@FETCH_STATUS <> -1)
	begin
		select @totmount=0,@totweight=0,@recno=1
		
		declare cursor_table2 cursor for
		select accy,tablea,noa,noq,n,mount,[weight],datea
		from #z_uccfe2 where productno =@productno and storeno=@storeno
		order by datea,pno
		open cursor_table2
		fetch next from cursor_table2
		into @accy,@tablea,@noa,@noq,@n,@mount,@weight,@curdate
		while(@@FETCH_STATUS <> -1)
		begin
			if @tablea='ucce'
			begin
				if @date=@curdate
				begin
					select @totmount=@totmount+@mount,@totweight=@totweight+@weight
				end
				else
				begin
					select @totmount=@mount,@totweight=@weight
					set @date=@curdate
				end
			end
			else
			begin
				select @totmount=@totmount+@mount*@n,@totweight=@totweight+@weight*@n
				set @date=@curdate
			end
		
			update #z_uccfe2 set totmount = @totmount,totweight=@totweight,recno=@recno
			where accy=@accy and tablea=@tablea and noa=@noa and noq=@noq and productno =@productno and storeno=@storeno
			set @recno = @recno + 1
			fetch next from cursor_table2
			into @accy,@tablea,@noa,@noq,@n,@mount,@weight,@curdate
		end
		close cursor_table2
		deallocate cursor_table2

		insert into #z_uccfe2(gno,productno,storeno,recno,datea,totmount,totweight)
		select '3',@productno,@storeno,@recno,CHAR(255),@totmount,@totweight
	
		fetch next from cursor_table
		into @productno,@storeno
	end
	close cursor_table
	deallocate cursor_table
	
	insert into #z_uccfe2(gno,productno,storeno,datea,totmount,totweight)
	select '4',productno,CHAR(255),CHAR(255),SUM(totmount),SUM(totweight)
	from #z_uccfe2 where gno='3' 
	group by productno
	----------------------------------------------------------------------------------
	declare @t_pageline int = 40 -- 一頁幾行
	declare @m int
	
	declare cursor_table cursor for
	select productno,count(1)from #z_uccfe2 group by productno
	open cursor_table
	fetch next from cursor_table
	into @productno,@m
	while(@@FETCH_STATUS <> -1)
	begin
		while @m%@t_pageline!=0
		begin
			insert into #z_uccfe2(gno,productno,storeno,datea)
			values('5',@productno,CHAR(255),CHAR(255))
			set @m = @m + 1
		end
		
		fetch next from cursor_table
		into @productno,@m
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------
	select * 
		,case tablea when 'stkucc' then '' else replace(replace(tablea,'_Ｘ',''),'_Ｚ','')+"?noa=\'"+noa+"\' and "+cast(recno as nvarchar)+"=$rr?"+accy end ghref
		,productno b01
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+case when len(isnull(product,''))=0 then productno else replace(product,'~#$',char(39)) end+'</a>' b02
		,recno rr
		,datea a01
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+[action]+'</a>' a02
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+case when len(isnull(store,''))=0 then storeno else [store] end+'</a>' a03
		,dbo.getComma(mount,2) a04
		,dbo.getComma([weight],2) a05
		,dbo.getComma(totmount,2) a06
		,dbo.getComma(totweight,2) a07
	from #z_uccfe2 order by productno,storeno,datea,recno,pno

	drop table #z_uccfe2;

z_uccfe1:--z_uccfe1 
	SET QUOTED_IDENTIFIER OFF
	declare @t_bproductno nvarchar(30) = case when '#non'=[1] then '' else [1] end
	declare @t_eproductno nvarchar(30) = case when '#non'=[2] then char(255) else [2] end
	declare @t_bstoreno nvarchar(20) = case when '#non'=[3] then '' else [3] end
	declare @t_estoreno nvarchar(20) = case when '#non'=[4] then char(255) else [4] end
	declare @t_enddate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	declare @t_bdate nvarchar(20) = case when '#non'=[6] then '' else [6] end
	declare @t_edate nvarchar(20) = case when '#non'=[7] then char(255) else [7] end
	declare @t_option01 nvarchar(max) = case when '#non'=[8] then '' else [8] end
	declare @t_showcarton nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_project nvarchar(20) = case when '#non'='[10]' then '' else '[10]' end
	declare @t_showprice nvarchar(20) = case when '#non'=[14] then '0' else [14] end
	------------------------------------------------------------------------------------
--前期
	declare @tmpa table(
		productno nvarchar(30),
		storeno nvarchar(30),
		mount decimal(18, 4),
		[weight] decimal(18, 4)
	)
	insert into @tmpa
	execute dbo.stkucc2 @t_enddate,@t_bstoreno,@t_estoreno,@t_bproductno,@t_eproductno 
	--select productno,storeno,mount,[weight]
	--from dbo.stkucc(@t_enddate,'','')
	
	if(@t_project='FE') --20160120 刪除不再產品主檔的庫存
	begin
		delete a from @tmpa a where not exists (select * from view_ucaucc where noa=a.productno)
	end
	------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_uccfe1')is not null
	BEGIN
		drop table #z_uccfe1
	END
	create table #z_uccfe1(
		gno nvarchar(10),
		grecno int,
		recno int,
		storeno nvarchar(30),
		store nvarchar(50),
		productno nvarchar(30),
		product nvarchar(100),
		unit nvarchar(20),
		mount decimal(18, 4),
		[weight] decimal(18, 4),
		price decimal(18, 4),
		[money] float
	)
	insert into #z_uccfe1(gno,recno,storeno,productno,mount,[weight])
	select '1',ROW_NUMBER()over(partition by productno order by storeno)
		,storeno,productno,mount,[weight]
	from @tmpa
	where not(mount=0 and [weight]=0)
	and productno between @t_bproductno and @t_eproductno
	and storeno between @t_bstoreno and @t_estoreno
	
	update #z_uccfe1 set product=ISNULL(b.product,''),unit=UPPER(ISNULL(b.unit,'')),store=ISNULL(c.store,'')
	from #z_uccfe1 a
	left join ucc b on a.productno=b.noa
	left join store c on a.storeno=c.noa
	
	-------------------------------------------------------------------------------------------
	if(@t_project='FE')
	begin
		update #z_uccfe1 set price = ISNULL(b.sprice,0)
			,[money]=ISNULL(case when a.unit='KG' or a.unit='公斤' or len(isnull(a.unit,''))=0 then a.[weight] else a.mount end*b.sprice,0)
		from #z_uccfe1 a
		outer apply(select top 1 y.sprice
			from uccp x
			left join uccps y on x.noa=y.noa
			where y.productno=a.productno and x.datea<=@t_enddate
			order by x.datea desc) b
	end
	else
	begin
		update #z_uccfe1 set price = ISNULL(b.price,0)
			,[money]=ISNULL(case when a.unit='KG' or a.unit='公斤' or len(isnull(a.unit,''))=0 then a.[weight] else a.mount end*b.price,0)
		from #z_uccfe1 a
		outer apply(select price from view_costs where mon=LEFT(@t_enddate,6) and productno=a.productno ) b	
	end
	---------------------------------------------------------------------------------------------
	insert into #z_uccfe1(gno,recno,productno,product,unit,mount,[weight],price,[money])
	select '2',0,productno,product,unit,sum(mount),sum([weight]),price,sum(isnull([money],0))
	from #z_uccfe1
	where gno = '1' 
	and (mount!=0 or [weight]!=0)
	group by productno,product,unit,price
	
	insert into #z_uccfe1(gno,recno,productno,mount,[weight],[money])
	select '3',0,CHAR(255),sum(mount),sum([weight]),sum(isnull([money],0))
	from #z_uccfe1
	where gno = '1' 
	and (mount!=0 or [weight]!=0)
	---------------------------------------------------------------------------------------------
	if len(@t_option01)=0
		delete #z_uccfe1 where gno='1'
	
	update #z_uccfe1 set grecno=b.recno
	from #z_uccfe1 a
	left join(select ROW_NUMBER()over(order by productno) recno,productno 
		from #z_uccfe1 where gno='2') b on a.productno=b.productno	
	
	declare @tmp table(
		gno nvarchar(10),
		grecno int,
		recno int,
		storeno nvarchar(30),
		store nvarchar(50),
		productno nvarchar(30),
		product nvarchar(100),
		unit nvarchar(20),
		mount decimal(18, 4),
		[weight] decimal(18, 4),
		price decimal(18, 4),
		[money] float,
		carton float
	)
	declare @counts int 
	declare @t_counts int 
	declare @t_line int =34
	
	if (@t_showcarton!='1')
	begin
		insert @tmp
		select case when a.gno='1' then '5' when a.gno='3' then '6' else a.gno end gno,
			case when a.gno ='3' then 999999 else a.grecno end ,a.recno,a.storeno,a.store,a.productno,a.product,a.unit,a.mount,a.[weight],
			a.price,a.[money],CEILING(a.mount/NULLIF(b.stdmount,0)) carton
		from #z_uccfe1 a left join ucc b on a.productno = b.noa order by productno,recno
	end
	else
	begin
		insert @tmp
		select case when a.gno='1' then '7' when a.gno='2' then '4' when a.gno='3' then '8' else a.gno end gno,
			case when a.gno ='3' then 999999 else a.grecno end ,a.recno,a.storeno,a.store,a.productno,a.product,a.unit,a.mount,a.[weight],
			a.price,a.[money],CEILING(a.mount/NULLIF(b.stdmount,0)) carton
		from #z_uccfe1 a left join ucc b on a.productno = b.noa order by productno,recno
		
		update @tmp
		set carton=(select SUM(isnull(carton,0)) from @tmp where gno in ('2','4')) where gno='8'
	end
	
	set @counts=((select count(*) from @tmp)/@t_line)+1
	set @t_counts=@counts
	while(@counts>0)
	begin
	
	insert @tmp(grecno,gno)
	select ((@counts-1)*@t_line)+1,
	case when @t_showcarton='1' then '3' else '1' end
	
	set @counts=@counts-1
	end
	
	if(@t_showprice='0')
	begin
		update @tmp set price=null,money=null
	end
  
	select * 
	,grecno rr
		,productno a01
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+replace(product,'~#$',char(39))+'</a>' a02
		,'<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+case when len(isnull(store,''))=0 then storeno else store end+'</a>' a03
		,dbo.getComma(mount,0) a04
		,dbo.getComma([weight],2) a05
		,dbo.getComma(price,2) a06
		,dbo.getComma([money],0) a07
		,dbo.getComma(carton,0) carton
		,dbo.getComma(isnull((select safemount from ucc where noa=a.productno),0),0) safe
	from @tmp a order by grecno,gno;