z_vccfe1:--z_vccfe1
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @taxtype nvarchar(10)
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'
declare @t_addr2 nvarchar(100)
declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
-------------------------------------------------------------------------------------------------------
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
set @taxtype = case when '#non' = [36] then '' else [36] end
--set @t_addr2 = case when '#non'=[39] then '' else [39] end
set @t_bmon = case when '#non' = [26] then '' else [26] end
set @t_emon = case when '#non' = [27] then char(255) else [27] end

if(@t_project='VU')
	set @qhref_acomp='_vu'
--***********************************************************************************
declare @result table(
	gno nvarchar(10),
	noa nvarchar(30),
	noq nvarchar(10),
	typea nvarchar(12),
	datea nvarchar(10),
	mon nvarchar(7),
	cno nvarchar(20),
	acomp nvarchar(50),
	custno nvarchar(30),
	comp nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(250),
	unit nvarchar(12),
	lengthb float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(max),
	invono nvarchar(max),
	idate nvarchar(30),
	imoney float,
	itax float,
	itotal float,
	sssno nvarchar(30),
	sss nvarchar(30)
)
insert into @result
	select '91' gno, a.noa noa, b.noq noq, a.typea typea, a.datea datea, (case when a.mon='' then left(a.datea,6) else a.mon end)
		,a.cno,a.acomp, a.custno, a.comp, b.productno, b.product, b.unit, 
		   b.lengthb,b.mount, b.weight, b.price, b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
		   ,a.invono,v.datea,v.money,v.tax,v.total,a.salesno,a.sales
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join view_ucaucc c on b.productno = c.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	left join vcca v on a.invono=v.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or c.groupano = @t_groupano) and
		  (len(@t_typea)=0 or isnull(c.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(c.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@taxtype)=0 or @taxtype=a.taxtype)
		  --and (len(@t_addr2)=0 or a.addr2 like '%'+@t_addr2+'%')
		  and (a.mon between @t_bmon and @t_emon)
	order by a.datea,gno,noa,noq
	
if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
begin
	delete @result where sssno!=@t_userno
end
	
if(@t_showinvono='1')
begin
	insert into @result(gno,datea,noa,noq,invono,idate,imoney,itax,itotal)
	select '92',datea,noa,'ZZZ',invono,idate,imoney,itax,itotal
	from @result group by datea,noa,invono,idate,imoney,itax,itotal
end
	
insert into @result(gno,datea,noa,mount,weight,price,total)
	select '93',datea,'ZZZZZZZZZZZZ',
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then mount else (-1)*weight end)),
		sum((case typea when '1' then price else (-1)*price end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result group by datea
	
insert into @result(gno,noa,mount,weight,price,total)
	select '94','ZZZZZZZZZZZZ',sum(mount),sum(weight),sum(price),sum(total)
	from @result a where gno='93'
--*************************************************************************	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
update @result set gno='0' where gno='91'
update @result set gno='1' where gno='92'
update @result set gno='2' where gno='93'
update @result set gno='3' where gno='94'

update @result
set mount=mount*-1,total=total*-1
where typea='退'

update @result set comp=a.custno+' '+isnull(b.nick,'')
from @result a
left join cust b on a.custno=b.noa

update @result set datea = (select MAX(datea) from @result) where gno='3'

select gno, noa, noq, typea, datea, LEFT(datea,6) xdatea, mon, custno, comp, productno, replace(xproduct,'~#$',char(39)) xproduct,unit,qhref
	,dbo.getComma(lengthb,2)  lengthb
	,dbo.getComma(mount,0)  mount
	,dbo.getComma(weight,0)  weight
	,dbo.getComma(price,[25])  price
	,dbo.getComma(total,0)  total
	,invono,idate
	,dbo.getComma(imoney,0)  imoney
	,dbo.getComma(itax,0)  itax
	,dbo.getComma(itotal,0)  itotal
from @result order by datea,noa,noq;
--*********************************************************************************************************
z_vccfe2:--z_vccfe2
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]' 

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
-------------------------------------------------------------------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(250),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	weight float,
	total float,
	sssno nvarchar(90),
	sss nvarchar(90)
)
	insert into @tmp
	select '9',b.productno,b.product,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.mount
		,(case when a.typea='1' then 1 else -1 end)*b.weight
		,(case when a.typea='1' then 1 else -1 end)*b.total
		,a.salesno,a.sales
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_cno)=0 or a.cno=@t_cno)
	order by b.productno,b.product,a.custno,c.nick,c.comp
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,SUM(mount),SUM(weight),SUM(total),sssno,sss from @tmp
	group by productno,products,cno,custnick,sssno,sss
	
	delete @tmp where gno='9'
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where sssno!=@t_userno
	end

	insert into @tmp(gno,cno,custnick,mount,weight,total) 
	select '1',cno,custnick,sum(mount),sum(weight),sum(total) 
	from @tmp where gno='0' group by cno,custnick 
	
select gno,productno,replace(products,'~#$',char(39)) products,cno,custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by cno,custnick,gno,productno;
--**************************************************************************************************
z_vccfe3:--z_vccfe3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_bproductno nvarchar(30)
	declare @t_eproductno nvarchar(30)
	declare @t_btggno nvarchar(50)
	declare @t_etggno nvarchar(50)
	declare @t_typea nvarchar(30)
	declare @t_groupano nvarchar(30)
	declare @t_stype nvarchar(30)
	declare @t_salesgroup nvarchar(100)
	declare @t_showinvono nvarchar(10)
	declare @t_project nvarchar(MAX)='[3]'
	declare @qhref_acomp nvarchar(10) ='fe'
	declare @vcctypea nvarchar(10) =''
	declare @t_partno nvarchar(30)
	declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
	declare @t_userno nvarchar(100)='[37]'
	declare @t_rank nvarchar(100)='[38]' 
	---------------------------------------------------------------------------------------------------------
	set @t_bdate = case when '#non'=[4] then '' else [4] end
	set @t_edate = case when '#non'=[5] then char(255) else [5] end
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bsalesno = case when '#non'=[10] then '' else [10] end
	set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
	set @t_bproductno = case when '#non'=[12] then '' else [12] end
	set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
	set @t_btggno = case when '#non' = [14] then '' else [14] end
	set @t_etggno = case when '#non' = [15] then char(255) else [15] end
	set @t_typea = case when '#non'=[16] then '' else [16] end
	set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
	set @t_stype = case when '#non'=[18] then '' else [18] end
	set @t_salesgroup = case when '#non' = [19] then '' else [19] end
	set @t_showinvono = case when '#non' = [22] then 0 else [22] end
	set @vcctypea = case when '#non' = [20] then '' else [20] end
	set @t_partno = case when '#non' = [21] then '' else [21] end
	if(@t_project='VU')
		set @qhref_acomp='_vu'
--------------------------------------------------
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(40),
		sssno nvarchar(50),
		sss nvarchar(50),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(250),
		unit nvarchar(8),
		lengthb float,
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''),a.salesno,a.sales, isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
	       b.lengthb,b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano)
		  and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_cno)=0 or a.cno=@t_cno)
	order by custno,productno,gno,datea,noa,noq
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @result where sssno!=@t_userno
	end

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @mount decimal(16,2)
	declare @weight decimal(16,2)
	declare @total decimal(18,0)
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @comp nvarchar(40)
	declare @sssno nvarchar(20)
	declare @sss nvarchar(40)
	declare @productno nvarchar(30)
	declare @xproduct nvarchar(40)
	declare @t_custno1 nvarchar(20)
	declare @t_comp1 nvarchar(40)
	declare @t_custno2 nvarchar(20)
	declare @t_comp2 nvarchar(40)
	declare @t_productno nvarchar(30)
	declare @t_xproduct nvarchar(40)
	declare @t_mount1 decimal(16,2)
	declare @t_weight1 decimal(16,2)
	declare @t_total1 decimal(18,0)
	declare @t_mount2 decimal(16,2)
	declare @t_weight2 decimal(16,2)
	declare @t_total2 decimal(18,0)
	set @t_custno1 = '#zzzz#zzzz'
	set @t_custno2 = '#zzzz#zzzz'
	set @t_productno = '#zzzz#zzzz'
	set @t_xproduct = ''
	set @t_mount1 = 0
	set @t_weight1 = 0
	set @t_total1 = 0
	set @t_mount2 = 0
	set @t_weight2 = 0
	set @t_total2 = 0

	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,custno,comp,sssno,sss,productno,xproduct,datea,total,mount,weight from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@sssno,@sss,@productno,@xproduct,@datea,@total,@mount,@weight
	while(@@FETCH_STATUS <> -1)
	begin
		if @gno='0'
		begin
			if NOT(@t_custno1 = @custno and @t_productno = @productno)
			begin
				if NOT(@t_custno1 = '#zzzz#zzzz' and @t_productno = '#zzzz#zzzz')
				begin   
					insert into @result
					select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno1, @t_comp1 comp,@sssno sssno,@sss sss, '' addr_invo, '' tel, 
						   @t_productno, @xproduct xproduct, '' unit,'', @t_mount1 mount, @t_weight1 weight, 0 price, @t_total1 total, 
						   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
				end
				set @t_custno1 = @custno
				set @t_comp1 = @comp
				set @t_productno = @productno
				set @t_xproduct = @xproduct
				set @t_mount1 = case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight1 = case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total1 = case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			else
			begin
				set @t_mount1 = @t_mount1 + case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight1 = @t_weight1 + case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total1 = @t_total1 + case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			
			if @t_custno2 != @custno
			begin
				if @t_custno2 != '#zzzz#zzzz'
				begin
					insert into @result
					select '2' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno2, @t_comp2 comp,@sssno sssno,@sss sss, '' addr_invo, '' tel, 
						   CHAR(255) productno, '' xproduct, '' unit,'', @t_mount2 mount, @t_weight2 weight, 0 price, @t_total2 total, 
						   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
				end
				set @t_custno2 = @custno
				set @t_comp2 = @comp
				set @t_mount2 = case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight2 = case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total2 = case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
			else
			begin
				set @t_mount2 = @t_mount2 + case @typea 
									when'1' then @mount 
									when'2' then -@mount 
									else 0 
								end 
				set @t_weight2 = @t_weight2 + case @typea 
									when'1' then @weight
									when'2' then -@weight
									else 0 
								end 
				set @t_total2 = @t_total2 + case @typea
									when'1' then @total
									when'2' then -@total
								end
			end
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@sssno,@sss,@productno,@xproduct,@datea,@total,@mount,@weight
	end
	close cursor_table
	deallocate cursor_table
	if NOT(@t_custno1 = '#zzzz#zzzz' and @t_productno = '#zzzz#zzzz')
	begin
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno1, @t_comp1 comp,@sssno sssno,@sss sss, '' addr_invo, '' tel, 
		       @t_productno, @xproduct xproduct, '' unit,'', @t_mount1 mount, @t_weight1 weight, 0 price, @t_total1 total, 
			   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
	end
	if @t_custno2 != '#zzzz#zzzz'
	begin
		insert into @result
		select '2' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno2, @t_comp2 comp,@sssno,@sss, '' addr_invo, '' tel, 
		       CHAR(255) productno, '' xproduct, '' unit,'', @t_mount2 mount, @t_weight2 weight, 0 price, @t_total2 total, 
			   0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update @result
	set mount=mount*-1,weight=weight*-1,total=total*-1
	where typea='退'

	select gno, typea, noa, noq, datea, mon, custno, comp
	,addr_invo,tel,productno,replace(xproduct,'~#$',char(39)) xproduct,unit
	,dbo.getComma(lengthb,2)  lengthb
	,dbo.getComma(mount,[23])  mount
	,dbo.getComma(weight,[24])  weight
	,dbo.getComma(price,[25])  price
	,dbo.getComma(total,0)  total
	,dbo.getComma(money,0)  money
	,dbo.getComma(back,0)  back
	,dbo.getComma(tax,0)  tax
	,dbo.getComma(total1,0)  total1
	,dbo.getComma(pay,0)  pay
	,dbo.getComma(unpay,0)  unpay
	,dbo.getComma(total2,0)  total2
	,pcount ,qhref
	from @result order by custno,productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vccfe4:--z_vccfe4
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]' 

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
-------------------------------------------------------------------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(250),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	weight float,
	total float,
	sssno nvarchar(30),
	sss nvarchar(30)
)

	insert into @tmp
	select '9',b.productno,b.product,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,(case when a.typea='1' then 1 else -1 end)*b.mount
		,(case when a.typea='1' then 1 else -1 end)*b.weight
		,(case when a.typea='1' then 1 else -1 end)*b.total
		,a.salesno,a.sales
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where (a.datea between @t_bdate and @t_edate) and (a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) 
			 and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_cno)=0 or a.cno=@t_cno)
	order by b.productno,b.product,a.custno,c.nick,c.comp
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where sssno!=@t_userno
	end
	
	insert into @tmp 
	select '0',productno,products,cno,custnick,SUM(mount),SUM(weight),SUM(total),sssno,sss from @tmp
	group by productno,products,cno,custnick,sssno,sss
	
	delete @tmp where gno='9'

	insert into @tmp(gno,productno,products,mount,weight,total) 
	select '1',productno,products,sum(mount),sum(weight),sum(total) 
	from @tmp where gno='0' group by productno,products 
	
	
select gno,productno,replace(products,'~#$',char(39)) products,cno,left(custnick,10) custnick
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by productno,products,gno,cno;
--**********************************************************************************************
z_vccfe5:--z_vccfe5
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]' 

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
if(@t_project='VU')
		set @qhref_acomp='_vu'
--------------------------------------------------
declare @result table(
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(3),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(20),
	comp nvarchar(40),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(250),
	unit nvarchar(8),
	lengthb float,
	mount float,
	weight float,
	price float,
	total float,
	pcount int,
	qhref nvarchar(MAX),
	sssno nvarchar(30),
	sss nvarchar(30)
)

insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, a.mon mon, 
		   a.custno custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
		   b.lengthb,b.mount, b.weight, b.price, b.total, 0 pcount,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy,a.salesno,a.sales
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_cno)=0 or a.cno=@t_cno)
	order by custno,gno,mon,datea,noa,noq
		
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @result where sssno!=@t_userno
	end
	
insert into @result(gno,custno,pcount,mount,weight,total)
	select '1',custno,
		count(*),
		sum((case typea when '1' then mount else (-1)*mount end)),
		sum((case typea when '1' then weight else (-1)*weight end)),
		sum((case typea when '1' then total else (-1)*total end))
	from @result a group by custno
	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @result
	set mount=mount*-1,weight=weight*-1,total=total*-1
	where typea='退'

select 
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,replace(xproduct,'~#$',char(39)) xproduct,unit, qhref
	,dbo.getComma(lengthb,2)  lengthb
	,dbo.getComma(mount,[23])  mount
	,dbo.getComma(weight,[24])  weight
	,dbo.getComma(price,[25])  price
	,dbo.getComma(total,0)  total
	,pcount 
from @result order by custno,gno,mon,datea,noa,noq;
--**********************************************************************************************
z_vccfe6:--z_vccfe6
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]' 

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
-------------------------------------------------------------------------------------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custs nvarchar(90),
	mon nvarchar(15),
	mount float,
	weight float,
	total float,
	tax float,
	sssno nvarchar(30),
	sss nvarchar(30)
)

insert into @tmp
	select
		'0',a.custno,(case when isnull(c.nick,'') = '' then c.comp else c.nick end),
		case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
		,sum((case when a.typea='1' then 1 else -1 end)*a.tax)
		,isnull(a.salesno,''),a.sales
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (a.custno between @t_bcustno and @t_ecustno) and (len(@t_groupano)=0 or d.groupano = @t_groupano)
			 and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea) and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_cno)=0 or a.cno=@t_cno)
	group by a.custno,c.nick,c.comp,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end,a.salesno,a.sales
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where sssno!=@t_userno
	end
	
if((select count(*) from @tmp)>0)
begin
	insert into @tmp(gno,custno,custs,mon,mount,weight,total,tax) 
	select '1',custno,custs,'999/99',sum(mount),sum(weight),sum(total),sum(tax) from @tmp group by custno,custs
	
	insert into @tmp(gno,custno,mount,weight,total,tax) 
	select '2','ZZZZ_ZZZ',sum(mount),sum(weight),sum(total), sum(tax) from @tmp where gno='1'
end

select gno,custno cno,left(custs,10) custs,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
,dbo.getComma(tax,0)  tax
from @tmp order by custno,mon,gno;
--**********************************************************************************************
z_vccfe7:--z_vccfe7
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
if(@t_project='VU')
	set @qhref_acomp='_vu'
-------------------------------------------------
	
	declare @result table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(20),
		comp nvarchar(40),
		sssno nvarchar(40),
		sss nvarchar(40),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(250),
		unit nvarchar(8),
		lengthb float,
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		total2 float,
		pcount int,
		qhref nvarchar(MAX)
		primary key (productno,gno,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end mon, 
		   a.custno custno, isnull(c.comp,''),a.salesno sssno,a.sales sss, isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,b.lengthb,
	       (case when a.typea='1' then 1 else -1 end) *b.mount, (case when a.typea='1' then 1 else -1 end) *b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	       ,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno) and
		  (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
		  and (len(@t_stype)=0 or a.stype = @t_stype) 
		  and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
		  and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
		  and (len(@vcctypea)=0 or a.typea = @vcctypea) 
		  and (len(@t_partno)=0 or s.partno=@t_partno)
		  and (len(@t_cno)=0 or a.cno=@t_cno)
	order by productno,gno,datea,noa,noq
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @result where sssno!=@t_userno
	end

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total decimal(18,0)
	declare @datea nvarchar(10)
	declare @productno nvarchar(30)
	declare @t_productno nvarchar(30)
	declare @t_money decimal(18,0)
	declare @t_back decimal(18,0)
	declare @t_tax decimal(18,0)
	declare @t_total1 decimal(18,0)
	declare @t_pcount int
	set @t_productno = '#zzzz#zzzz'
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,productno,datea,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@productno,@datea,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_productno != @productno
		begin
			if @t_productno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @result
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' ssno, '' sss, '' addr_invo, '' tel, 
				       @t_productno, '' product, '' unit,'', 0 mount, 0 weight, 0 price, 0 total, 
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
			end
			set @t_productno = @productno
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@productno,@datea,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_productno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result
		select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, '' custno, '' comp, '' ssno, '' sss, '' addr_invo, '' tel, 
		       @t_productno, '' product, '' unit,'', 0 mount, 0 weight, 0 price, 0 total, 
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,''
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	update a 
	set mount=(select sum(mount) from @result where gno='0' and productno=a.productno) 
	,weight=(select sum(weight) from @result where gno='0' and productno=a.productno) 
	from @result a	where gno='1' 
	
	update @result
	set total=total*-1
	where typea='退'
	
	select gno, typea, noa, noq, datea, mon, custno, left(comp,10) comp
	,addr_invo,tel,productno,replace(xproduct,'~#$',char(39)) xproduct,unit, qhref
	,dbo.getComma(lengthb,2)  lengthb
	,dbo.getComma(mount,[23])  mount
	,dbo.getComma(weight,[24])  weight
	,dbo.getComma(price,[25])  price
	,dbo.getComma(total,0)  total
	,dbo.getComma(money,0)  money
	,dbo.getComma(back,0)  back
	,dbo.getComma(tax,0)  tax
	,dbo.getComma(total1,0)  total1
	,dbo.getComma(pay,0)  pay
	,dbo.getComma(unpay,0)  unpay
	,dbo.getComma(total2,0)  total2
	,pcount 
	from @result order by productno,gno,datea,noa,noq;
--**********************************************************************************************
z_vccfe8:--z_vccfe8
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
--------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	sssno nvarchar(30),
	sss nvarchar(30),
	productno nvarchar(30),
	products nvarchar(250),
	mon nvarchar(15),
	mount float,
	weight float,
	total float
)
insert into @tmp
	select
		'0',a.salesno,a.sales,b.productno,b.product,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
	 		(a.custno between @t_bcustno and @t_ecustno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_cno)=0 or a.cno=@t_cno)
	group by a.salesno,a.sales,b.productno,b.product,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where sssno!=@t_userno
	end
	
if((select count(*) from @tmp)>0)
begin
	insert into @tmp(gno,productno,products,mon,mount,weight,total)
	select '1',productno,products,'999/99',sum(mount),sum(weight),sum(total)
	from @tmp group by productno,products
	
	insert into @tmp(gno,productno,mount,weight,total)
	select '2','ZZZZZZZZZZZZ',sum(mount),sum(weight),sum(total)
	from @tmp where gno='1'
end

select gno,productno
,replace((case when gno='0' then dbo.charbr(products,24) else products end ),'~#$',char(39)) products,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by productno,mon,gno;
--**********************************************************************************************
z_vccfe9:--z_vccfe9
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
if(@t_project='VU')
	set @qhref_acomp='_vu'
--------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	productno nvarchar(30),
	products nvarchar(max),
	unit nvarchar(15),
	lengthb float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(max)
)

insert into @tmp
	select '0',a.salesno,a.sales,a.comp,a.datea,a.noa,a.typea,b.productno,b.product,b.unit,b.lengthb,b.mount,b.weight,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_cno)=0 or a.cno=@t_cno)
	order by a.salesno,a.datea
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where salesno!=@t_userno
	end
	
insert into @tmp(gno,salesno,salesname,mount,weight,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then weight else weight*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,weight=weight*-1,total=total*-1
where typea='退'

select gno,salesno,salesname,left(comp,10)comp,datea,noa,typea,productno
,replace(products,'~#$',char(39)) products,unit,qhref
,dbo.getComma(lengthb,2)  lengthb
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(price,[25])  price
,dbo.getComma(total,0)  total
from @tmp order by salesno,salesname,gno,datea,productno;
--**********************************************************************************************
z_vccfe10:--z_vccfe10
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
--------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(90),
	mon nvarchar(15),
	mount float,
	weight float,
	total float
)

insert into @tmp
	select
		'0',a.salesno,a.sales,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where  (a.datea between @t_bdate and @t_edate) and --(isnull(a.salesno,'') != '') and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and  (a.custno between @t_bcustno and @t_ecustno) 
			and (len(@t_stype)=0 or a.stype = @t_stype) 
			and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_cno)=0 or a.cno=@t_cno)
	group by a.salesno,a.sales,case when isnull(a.mon,'')!='' then a.mon else left(a.datea,6) end
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where isnull(salesno,'')!=@t_userno
	end

if((select count(*) from @tmp)>0)
begin	
	insert into @tmp(gno,salesno,salesname,mon,mount,weight,total)
	select '1',salesno,salesname,'999/99',sum(mount),sum(weight),sum(total)
	from @tmp group by salesno,salesname
	
	insert into @tmp(gno,salesno,mount,weight,total)
	select '2','ZZZZZZ',sum(mount),sum(weight),sum(total)
	from @tmp where gno='1'
end

select gno,salesno sno,salesname,mon
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by salesno,mon,gno;
--**********************************************************************************************
z_vccfe11:--z_vccfe11
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
if(@t_project='VU')
	set @qhref_acomp='_vu'
--------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	comp nvarchar(100),
	productno nvarchar(30),
	products nvarchar(max),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	unit nvarchar(15),
	lengthb float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(MAX)
)
insert into @tmp
	select '0',a.salesno,a.sales,a.comp,b.productno,b.product,a.datea,a.noa,a.typea,b.unit,b.lengthb,b.mount,b.weight,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and(len(@t_cno)=0 or a.cno=@t_cno)
	order by a.salesno,b.productno
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where salesno!=@t_userno
	end
	
insert into @tmp(gno,salesno,salesname,mount,weight,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then weight else weight*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,weight=weight*-1,total=total*-1
where typea='退'

select 
gno,salesno,salesname,left(comp,10) comp,productno,replace(products,'~#$',char(39)) products,datea,noa,typea,unit, qhref
,dbo.getComma(lengthb,2)  lengthb
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(price,[25])  price
,dbo.getComma(total,0)  total
from @tmp order by salesno,salesname,gno,productno,datea;
--**********************************************************************************************
z_vccfe12:--z_vccfe12
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
--------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	mount float,
	weight float,
	total float
)

insert into @tmp
	select '0',a.salesno,a.sales,b.productno,b.product
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and 
			  (a.custno between @t_bcustno and @t_ecustno) and 
			 --(isnull(a.salesno,'') != '') and 
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and(len(@t_cno)=0 or a.cno=@t_cno)
	group by a.salesno,a.sales,b.productno,b.product
	order by a.salesno,b.productno

	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where salesno!=@t_userno
	end

if((select count(*) from @tmp)>0)
begin
	insert into @tmp(gno,mount,weight,total)
	select '1',sum(mount),sum(weight),sum(total)
	from @tmp
end

select gno,salesno sno ,salesname,productno,replace(products,'~#$',char(39)) products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by gno,salesno,productno;
--**********************************************************************************************
z_vccfe13:--z_vccfe13
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
if(@t_project='VU')
	set @qhref_acomp='_vu'
--------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	datea nvarchar(10),
	noa nvarchar(35),
	typea nvarchar(15),
	unit nvarchar(15),
	lengthb float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(MAX)
)

insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,a.sales,b.productno,b.product,a.datea,a.noa,a.typea,b.unit,b.lengthb,b.mount,b.weight,b.price,b.total
	,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_cno)=0 or a.cno=@t_cno)
	order by a.salesno,a.custno,b.productno
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where salesno!=@t_userno
	end
	
insert into @tmp(gno,salesno,salesname,mount,weight,total)
	select '1' gno,salesno,salesname,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then weight else weight*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end)) 
	from @tmp group by salesno,salesname

update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,weight=weight*-1,total=total*-1
where typea='退'

select gno,custno,custnick,salesno,salesname,productno,replace(products,'~#$',char(39)) products,datea,noa,typea,unit,qhref
,dbo.getComma(lengthb,2)  lengthb
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(price,[25])  price
,dbo.getComma(total,0)  total
from @tmp order by salesno,gno,custno,productno,datea;
--**********************************************************************************************
z_vccfe14:--z_vccfe14
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
--------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(30),
	custnick nvarchar(90),
	salesno nvarchar(30),
	salesname nvarchar(50),
	productno nvarchar(30),
	products nvarchar(max),
	mount float,
	weight float,
	total float
)
insert into @tmp
	select '0',a.custno,(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
	a.salesno,a.sales,b.productno,b.product
	,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
	,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
	,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b  on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'')between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and --(isnull(a.salesno,'') != '') and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			and (len(@vcctypea)=0 or a.typea = @vcctypea)
			and (len(@t_partno)=0 or s.partno=@t_partno)
			and (len(@t_cno)=0 or a.cno=@t_cno)
	group by a.salesno,a.sales,a.custno,c.nick,c.comp,b.productno,b.product
	order by a.salesno,a.custno,b.productno
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where salesno!=@t_userno
	end

if((select count(*) from @tmp)>0)
begin
	insert into @tmp(gno,mount,weight,total)
	select '1',	sum(mount),sum(weight),	sum(total)
	from @tmp
end

select gno,custno,left(custnick,7) custnick,salesno sno ,salesname,productno,replace(products,'~#$',char(39)) products
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by gno,salesno,custno,productno;
--**********************************************************************************************
z_vccfe15:--z_vccfe15
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @qhref_acomp nvarchar(10) ='fe'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
if(@t_project='VU')
	set @qhref_acomp='_vu'
--------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(250),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	datea nvarchar(10),
	noa nvarchar(30),
	typea nvarchar(15),
	lengthb float,
	mount float,
	weight float,
	price float,
	total float,
	qhref nvarchar(MAX)
)
insert into @tmp
	select
		'0',b.productno,b.product,a.salesno,a.sales,a.custno,
		(case when isnull(c.nick,'') = '' then left(c.comp,10) else c.nick end),
		a.datea,a.noa,a.typea,b.lengthb,b.mount,b.weight,b.price,b.total,'vcc'+@qhref_acomp+'?noa=$noa?'+a.accy
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno) and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_cno)=0 or a.cno=@t_cno)
	order by b.productno,b.product,a.salesno,a.sales,a.custno,c.nick,c.comp,a.datea,a.noa,a.typea
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where sno!=@t_userno
	end
	
insert into @tmp(gno,productno,products,mount,weight,total)
	select '1',productno,products,
		sum((case when typea='1' then mount else mount*(-1) end)),
		sum((case when typea='1' then weight else weight*(-1) end)),
		sum((case when typea='1' then total else total*(-1) end))
	from @tmp group by productno,products
	
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

update @tmp
set mount=mount*-1,weight=weight*-1,total=total*-1
where typea='退'

select gno,productno,replace(products,'~#$',char(39)) products,sno,salesname,cno,custnick,datea,noa,typea, qhref
,dbo.getComma(lengthb,2)  lengthb
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(price,[25])  price
,dbo.getComma(total,0)  total
from @tmp order by productno,products,gno,sno,cno,datea,typea;
--**********************************************************************************************
z_vccfe16:--z_vccfe16
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_btggno nvarchar(50)
declare @t_etggno nvarchar(50)
declare @t_typea nvarchar(30)
declare @t_groupano nvarchar(30)
declare @t_stype nvarchar(30)
declare @t_salesgroup nvarchar(100)
declare @t_showinvono nvarchar(10)
declare @t_project nvarchar(MAX)='[3]'
declare @vcctypea nvarchar(10) =''
declare @t_partno nvarchar(30)
declare @t_cno nvarchar(max) = case when '#non'=[35] then '' else [35] end
declare @t_userno nvarchar(100)='[37]'
declare @t_rank nvarchar(100)='[38]'

set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[8] then '' else [8] end
set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
set @t_bsalesno = case when '#non'=[10] then '' else [10] end
set @t_esalesno = case when '#non'=[11] then char(255) else [11] end
set @t_bproductno = case when '#non'=[12] then '' else [12] end
set @t_eproductno = case when '#non'=[13] then char(255) else [13] end
set @t_btggno = case when '#non' = [14] then '' else [14] end
set @t_etggno = case when '#non' = [15] then char(255) else [15] end
set @t_typea = case when '#non'=[16] then '' else [16] end
set @t_groupano = case when '#non'=[17] then '' else (case when [17] = ' ' then '' else [17] end) end
set @t_stype = case when '#non'=[18] then '' else [18] end
set @t_salesgroup = case when '#non' = [19] then '' else [19] end
set @t_showinvono = case when '#non' = [22] then 0 else [22] end
set @vcctypea = case when '#non' = [20] then '' else [20] end
set @t_partno = case when '#non' = [21] then '' else [21] end
--------------------------------------------------
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(250),
	sno nvarchar(30),
	salesname nvarchar(90),
	cno nvarchar(30),
	custnick nvarchar(90),
	mount float,
	weight float,
	total float
)
insert into @tmp
	select
		'0',b.productno,b.product,a.salesno,a.sales,a.custno,
		(case when isnull(c.nick,'') = '' then c.comp else c.nick end)
		,sum((case when a.typea='1' then 1 else -1 end)*b.mount)
		,sum((case when a.typea='1' then 1 else -1 end)*b.weight)
		,sum((case when a.typea='1' then 1 else -1 end)*b.total)
	from view_vcc a
	left join view_vccs b on a.noa = b.noa and a.accy = b.accy
	left join cust c on a.custno = c.noa
	left join view_ucaucc d on b.productno = d.noa
	left join sss s on isnull(a.salesno,'')=s.noa
	where (a.datea between @t_bdate and @t_edate) and
			 (a.custno between @t_bcustno and @t_ecustno) and 
			 (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno) and 
			 (b.productno between @t_bproductno and @t_eproductno) and
			 (len(@t_groupano)=0 or d.groupano = @t_groupano) and (len(@t_typea)=0 or isnull(d.typea,'null') = @t_typea)
			 and (len(@t_stype)=0 or a.stype = @t_stype) 
			 and (len(@t_salesgroup)=0 or s.salesgroup=@t_salesgroup)
			 and (isnull(d.tggno,'') between @t_btggno and @t_etggno)
			 and (len(@vcctypea)=0 or a.typea = @vcctypea) 
			 and (len(@t_partno)=0 or s.partno=@t_partno)
			 and (len(@t_cno)=0 or a.cno=@t_cno)
	group by b.productno,b.product,a.salesno,a.sales,a.custno,c.nick,c.comp
	order by b.productno,b.product,a.salesno,a.sales,a.custno,c.nick,c.comp
	
	if(@t_rank<'8' and left(@t_userno,1)='B' and @t_project='FE')
	begin
		delete @tmp where sno!=@t_userno
	end

if((select count(*) from @tmp)>0)
begin
	insert into @tmp(gno,productno,products,mount,weight,total)
	select '1',productno,products,sum(mount),sum(weight),sum(total)
	from @tmp group by productno,products
end
	
select gno,productno,replace(products,'~#$',char(39)) products,sno,salesname,cno,left(custnick,10) custnick 
,(case @t_stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '樣品' else '' end) stype
,dbo.getComma(mount,[23])  mount
,dbo.getComma(weight,[24])  weight
,dbo.getComma(total,0)  total
from @tmp order by productno,products,gno,sno,cno;
--**********************************************************************************************
z_vccfe17:--z_vccfe17
	declare @t_bcustno nvarchar(50)
	declare @t_ecustno nvarchar(50)
	declare @t_bvmon nvarchar(10)
	declare @t_evmon nvarchar(10)
	declare @t_bvdate nvarchar(10)
	declare @t_evdate nvarchar(10)
	declare @t_budate nvarchar(10)
	declare @t_eudate nvarchar(10)
	declare @t_odate nvarchar(10)
	declare @t_title nvarchar(MAX)
	declare @show_umm nvarchar(10) --判斷是否要顯示收款明細
	
	set @t_bcustno = case when '#non'=[8] then '' else [8] end
	set @t_ecustno = case when '#non'=[9] then char(255) else [9] end
	set @t_bvmon = case when '#non'=[26] then '' else [26] end
	set @t_evmon = case when '#non'=[27] then char(255) else [27] end
	set @t_bvdate = case when '#non'=[28] then '' else [28] end
	set @t_evdate = case when '#non'=[29] then char(255) else [29] end
	set @t_budate = case when '#non'=[30] then '' else [30] end
	set @t_eudate = case when '#non'=[31] then char(255) else [31] end
	set @t_odate = case when '#non'=[32] then '' else [32] end
	set @t_title = case when '#non'=[33] then '' else [33] end
	
	if([30]='#non' and [31]='#non')
		set @show_umm='0'
	else
		set @show_umm='1'
	--***********************************************************************************
	---------------(前期未收金額)顯示每個月份應收金額 begin--------------------------------------------------------------------------------------------
	declare @tmpa table(
		custno nvarchar(20),
		money float,
		mon nvarchar(MAX)
	)
	
	insert into @tmpa (custno,money,mon)
	select noa,unpay,mon from cust_2s where noa between @t_bcustno and @t_ecustno
	and mon < @t_bvmon
	
	--select custno,SUM(money),mon from (
	--vcc =前期未收-前期已收月結
	--	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno
	--	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*total,0))
	--	-ISNULL((select sum(paysale) from umms a left join view_vcc b on a.vccno=b.noa where (case when b.custno2!='' then b.custno2 else b.custno end)=(case when aa.custno2!='' then aa.custno2 else aa.custno end) and (case when len(b.mon)=0 then left(b.datea,6) else b.mon end)=(case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end)),0)
	--	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)!='-TAX' and right(vccno,6)=(case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money
	--	,(case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) mon
	--	from view_vcc aa left join cust bb on aa.custno=bb.noa 
	--	where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bvmon 
	--	and (left(isnull(kind,''),4)!='健勞勞退')
	--	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end)
	--vcca=前期全部稅額-前期已收稅額
	--	union all
	--	select ca.custno
	--	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),6)<@t_bvmon and left(vccno,len(vccno)-11)=ca.custno),0)
	--	,(case when len(ca.mon)=0 then LEFT(ca.datea,6) else ca.mon end)mon
	--	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	--	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) < @t_bvmon and ([2]!=3)
	--	and (ca.taxtype='1' or ca.taxtype='5')
	--	group by ca.custno,(case when len(ca.mon)=0 then LEFT(ca.datea,6) else ca.mon end)
	--)tmp where custno between @t_bcustno and @t_ecustno group by custno,mon
	
	delete @tmpa where money=0
	--------------------顯示每個月份應收金額 end---------------------------------------------------------------------------------------
	--***********************************************************************************
	declare @result table(
		gno nvarchar(10),
		typea nvarchar(4),
		noa nvarchar(15),
		noq nvarchar(3),
		datea nvarchar(10),
		mon nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		product nvarchar(40),
		unit nvarchar(8),
		mount float,
		weight float,
		price float,
		total float,
		money float,
		back float,
		tax float,
		total1 float,
		pay float,
		unpay float,
		unvcc float,
		buvdate nvarchar(50),
		euvdate nvarchar(50),
		total2 float,
		btotal float,
		unmon nvarchar(50),
		paymemo nvarchar(50),
		opay float,
		acomp nvarchar(50),
		cash float,
		remit float,
		lc float,
		other float,
		discount float,
		checkno nvarchar(50),
		bank nvarchar(50),
		indate nvarchar(10),
		fax nvarchar(50),
		pcount int,
		qhref nvarchar(MAX)
		primary key (custno,gno,mon,datea,noa,noq) 
	)
	
	insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,6) else a.mon end) mon, 
		   (case when a.custno2!='' then a.custno2 else a.custno end) custno
		   , isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit, 
	       b.mount, b.weight, b.price, b.total, a.money money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 unvcc,'','', 0 total2, 0 btotal
	       ,'' unmon,'' paymemo,0 opay,'' acomp,0,0,0,0,0,'','','','', 0 pcount,'vccfe?noa=$noa?'+a.accy
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa
	where (a.datea between @t_bvdate and @t_evdate) and
		  ((case when a.mon='' then left(a.datea,6) else a.mon end) between @t_bvmon and @t_evmon) 
		  and ((case when a.custno2!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) 
	union all --無發票系統
	select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,6) else mon end), 
		    (case when custno2!='' then custno2 else custno end),  
		     (case when custno2!='' then comp2 else comp end),
		     '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 unvcc,'','', 0 total2, 0 btotal
		   ,'' unmon,'' paymemo,0 opay,'' acomp,0,0,0,0,0,'','','','', 0 pcount,'vccfe?noa=$noa?'
	from view_vcc
	where tax > 0 and (taxtype='1' or taxtype='5') and
		  (datea between @t_bvdate and @t_evdate)and
		  ((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
		  ((case when custno2!='' then custno2 else custno end) between @t_bcustno and @t_ecustno)
	union all --有發票系統
	select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,6) else mon end), 
		   custno, comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit, 
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 unvcc,'','', 0 total2, 0 btotal
		   ,'' unmon,'' paymemo,0 opay,'' acomp,0,0,0,0,0,'','','','', 0 pcount,'vcca?noa=$noa?'
	from vcca 
	where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
			(datea between @t_bvdate and @t_evdate)and
		  ((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
		  (custno between @t_bcustno and @t_ecustno)
		  and noa not in (select invono from view_vcc where tax > 0 and
		  (datea between @t_bvdate and @t_evdate)and
		  ((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
		  (custno between @t_bcustno and @t_ecustno) ) 	    	  
	order by custno,gno,mon,datea,noa,noq

	--***********************************************************************
	declare @gno nvarchar(1)
	declare @typea nvarchar(4)
	declare @noa nvarchar(15)
	declare @total float
	declare @mon nvarchar(7)
	declare @custno nvarchar(20)
	declare @comp nvarchar(40)
	declare @t_custno nvarchar(20)
	declare @t_comp nvarchar(40)
	declare @t_money float
	declare @t_back float
	declare @t_tax float
	declare @t_total1 float
	declare @t_pay float
	declare @t_unpay float
	declare @t_total2 float
	declare @t_pcount int
	declare @endday int 
	declare @enddate nvarchar(50)
	
	set @t_custno = '#zzzz#zzzz'
	set @t_comp = ''
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pay = 0
	set @t_unpay = 0
	set @t_total2 = 0
	set @t_pcount = 0
	--***********************************************************************
	declare cursor_table cursor for
	select gno,typea,custno,comp,mon,total from @result
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_custno != @custno
		begin
			if @t_custno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				----------------------------------------------------------------------------------------------------------------------------
				insert into @result (gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
				select '1' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
								
				--gno2 目前不用 要抓客戶的期初金額跟月份
				
				--出貨金額
				insert into @result(gno,noa,noq,mon,datea,custno,comp,weight,money,back,tax,total1,pcount)
				select '3' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,isnull((select sum(weight) from @result where custno=@t_custno and gno='0'),0),@t_money, @t_back, @t_tax, @t_total1, @t_pcount
					   
				--退貨金額
				if(@t_back!=0)
				begin	   
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '4' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
				end
					   
				--稅額
				if(@t_tax!=0)
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '5' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
				end
				
				--本期應收
				if (@t_total1!=0)
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '6' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
				end
				
				--前期
				if(select COUNT(*) from @tmpa where custno=@t_custno)>0
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,unmon,unpay)
					select '7' gno,'' ,'' ,mon, '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount,mon,money
					from @tmpa where custno=@t_custno
				end
				
				--出貨未收
				if(@t_bvdate!='' and @t_bvmon+'/01'<@t_bvdate and isnull((select  b.total from view_vccs b left join view_vcc a on a.noa = b.noa
					where (a.datea not between @t_bvdate and @t_evdate) and
						((case when a.mon='' then left(a.datea,6) else a.mon end) between @t_bvmon and @t_evmon)
						and(case when a.custno2!='' then a.custno2 else a.custno end)=@t_custno
					union all --無發票系統
					select tax	from view_vcc
					where tax > 0 and (taxtype='1' or taxtype='5') and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
						((case when custno2!='' then custno2 else custno end)=@t_custno)
					union all --有發票系統
					select tax from vcca 
					where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno)
						and noa not in (select invono from view_vcc where tax > 0 and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno))
					),0)!=0)
				begin
					set @enddate=cast(CONVERT (VARCHAR(7),DATEADD(day, -1, convert(datetime,cast(cast(LEFT(@t_bvdate,3)as int)+1911 as nvarchar(10))+'/'+right(@t_bvdate,5))),12 )+0890000 as nvarchar(20))
					set @enddate=left(@enddate,3)+'/'+left(right(@enddate,4),2)+'/'+right(@enddate,2)
				
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,unvcc,buvdate,euvdate)
					select '8' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
					,isnull((select  b.total from view_vccs b left join view_vcc a on a.noa = b.noa
					where (a.datea not between @t_bvdate and @t_evdate) and
						((case when a.mon='' then left(a.datea,6) else a.mon end) between @t_bvmon and @t_evmon)
						and(case when a.custno2!='' then a.custno2 else a.custno end)=@t_custno
					union all --無發票系統
					select tax	from view_vcc
					where tax > 0 and (taxtype='1' or taxtype='5') and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
						((case when custno2!='' then custno2 else custno end)=@t_custno)
					union all --有發票系統
					select tax from vcca 
					where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno)
						and noa not in (select invono from view_vcc where tax > 0 and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno))
					),0),@t_bvmon+'/01',@enddate
				end
				
				--已收金額
				if(select isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=@t_custno)),0) --本期單據以沖金額 
					+isnull((select SUM(ub.paysale) from umms ub 
					where charindex(@t_custno+'-',ub.vccno)>0 
					and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' between @t_bvdate and @t_evdate 
					and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) between @t_bvmon and @t_evmon),0))!=0
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '9' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
				end
				
				--預收累計
				if(@t_odate!='' and (select SUM(opay - unopay) total from umm where custno=@t_custno and datea<=@t_odate)!=0)
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,opay)
					select '10' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
					,(select SUM(opay - unopay) total from umm where custno=@t_custno and datea<=@t_odate)
				end
				
				--應收總計
				insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
				select '11' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
				
				--支票請開
				if((select count(*) from @result where custno=@t_custno and isnull(typea,'')='稅')>0)
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,acomp)
					select '12' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,
					(select sum(total) from vcca where noa in (select noa from @result where custno=@t_custno))
					, @t_pcount,(select top 1 acomp from vcca where noa in (select noa from @result where custno=@t_custno))
				end
				
				--支票請不開抬頭
				if(@t_total1-isnull((select sum(total) from vcca where noa in (select noa from @result where custno=@t_custno)),0)>50)
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '13' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1-isnull((select sum(total) from vcca where noa in (select noa from @result where custno=@t_custno)),0), @t_pcount
				end
				
				--請勿尾折
				if isnull((select MIN(paydate) from view_vcc where noa in (select noa from @result where custno=@t_custno) and ISNULL(paydate,'')!=''),'')!=''
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,paymemo)
					select '14' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
					,'到期日：'+ isnull((select MIN(paydate) from view_vcc where noa in (select noa from @result where custno=@t_custno) and ISNULL(paydate,'')!=''),'') +' 請勿尾折'
				end
				else
				begin
					
					if charindex('貨到現金',(select top 1 paytype from cust where noa=@t_custno))>0
					or charindex('月結現金',(select top 1 paytype from cust where noa=@t_custno))>0
					or charindex('貨到現金',(select top 1 paytype from view_vcc where noa in(select noa from @result where custno=@t_custno) order by noa))>0
					or charindex('月結現金',(select top 1 paytype from view_vcc where noa in(select noa from @result where custno=@t_custno) order by noa))>0
					begin
						insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,paymemo)
						select '14' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
						,'付款方式：'+(select top 1 paytype from cust where noa=@t_custno)+' 請勿尾折'
					end
					else
					begin
						if(isnull((select paytype from cust where noa=@t_custno and CHARINDEX('天',paytype)>0),'')!='')
						begin
							set @endday=(select SUBSTRING(REPLACE(paytype,' ',''),patindex('%[0-9]%',REPLACE(paytype,' ','')),len(REPLACE(paytype,' ',''))-patindex('%[0-9]%',REPLACE(paytype,' ',''))-1) from cust where noa=@t_custno and CHARINDEX('天',paytype)>0)
							
							set @enddate=(select cast(CONVERT (VARCHAR(7),DATEADD(day, -1+@endday, convert(datetime,(convert(char(7),dateadd(month,1,
							case when @t_evmon !='' then cast(cast(LEFT(@t_evmon,3)as int)+1911 as nvarchar(10))+'/'+right(@t_evmon,2)+'/01' 
							when @t_evdate!='' then cast(cast(LEFT(@t_evdate,3)as int)+1911 as nvarchar(10))+'/'+right(@t_evdate,5)	else getdate() end ),111)+'/01'))),12 )+0890000 as nvarchar(20)))
							
							set @enddate=left(@enddate,3)+'/'+left(right(@enddate,4),2)+'/'+right(@enddate,2)
							
							insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,paymemo)
							select '14' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
							,'到期日：'+@enddate+' 請勿尾折'
						end
					end
				end
				
				--前期未付金額，請依上月發票抬頭開立支票
				if(select COUNT(*) from @tmpa where custno=@t_custno)>0
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '15' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
				end
				
				--收款明細
				if(@show_umm='1' and (select COUNT(*) from umm a left join umms b on a.noa=b.noa left join view_vcc c on b.vccno=c.noa where a.datea between @t_budate and @t_eudate and (case when a.custno!='' then a.custno when c.custno!='' then c.custno else c.custno2 end)=@t_custno and b.money>0 )>0)
				begin
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
					select '16' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
					
					insert into @result(gno,noa,noq,mon,datea,custno,comp,cash,remit,lc,other,discount,checkno,bank,money,indate)
					select '17',a.noa,b.noq,'',a.datea, @t_custno, @t_comp comp
					,case when b.acc1 like '1111.%' then b.money else null end
					,case when b.acc1 like '1112.%' then b.money else null end
					,case when b.acc2 like '%LC%' or b.acc2 like '%L/C%' then b.money else null end
					,case when b.acc1 like '2123.%'then b.money else null end
					,case when b.acc1 like '4202.%' then b.money else null end
					,case when b.acc1 like '1121.%' then b.checkno else null end
					,case when b.acc1 like '1121.%' then b.bank else null end
					,case when b.acc1 like '1121.%' then b.money else null end
					,case when b.acc1 like '1121.%' then b.indate else null end
					from umm a left join umms b on a.noa=b.noa left join view_vcc c on b.vccno=c.noa where a.datea between @t_budate and @t_eudate and (case when a.custno!='' then a.custno when c.custno!='' then c.custno else c.custno2 end)=@t_custno	and b.money>0
					
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,fax)
					select '18' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
					,(select top 1 d.fax from umm a left join umms b on a.noa=b.noa left join view_vcc c on b.vccno=c.noa left join acomp d on a.cno=d.noa 
					where a.datea between @t_budate and @t_eudate and (case when a.custno!='' then a.custno when c.custno!='' then c.custno else c.custno2 end)=@t_custno)
				end
				
				--分頁
				insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
				select '19' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
			----------------------------------------------------------------------------------------------------------------------------------
			end
			set @t_custno = @custno
			set @t_comp = @comp
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@mon,@total
	end
	close cursor_table
	deallocate cursor_table
	
	if @t_custno != '#zzzz#zzzz'
	begin
		set @t_total1 = @t_money - @t_back + @t_tax
		insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
		select '1' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
		
		--gno2 目前不用 要抓客戶的期初金額跟月份
				
		--出貨金額
		insert into @result(gno,noa,noq,mon,datea,custno,comp,weight,money,back,tax,total1,pcount)
		select '3' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,isnull((select sum(weight) from @result where custno=@t_custno and gno='0'),0),@t_money, @t_back, @t_tax, @t_total1, @t_pcount
					   
		--退貨金額
		if(@t_back!=0)
		begin	   
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '4' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
		end
					   
		--稅額
		if(@t_tax!=0)
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '5' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
		end
		
		--本期應收
		if (@t_total1!=0)
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '6' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
		end
		
		--前期
		if(select COUNT(*) from @tmpa where custno=@t_custno)>0
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,unmon,unpay)
			select '7' gno,'' ,'' ,mon, '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount,mon,money
			from @tmpa where custno=@t_custno
		end
		
		--出貨未收
		if(@t_bvdate!='' and @t_bvmon+'/01'<@t_bvdate and isnull((select  b.total from view_vccs b left join view_vcc a on a.noa = b.noa
					where (a.datea not between @t_bvdate and @t_evdate) and
						((case when a.mon='' then left(a.datea,6) else a.mon end) between @t_bvmon and @t_evmon)
						and(case when a.custno2!='' then a.custno2 else a.custno end)=@t_custno
					union all --無發票系統
					select tax	from view_vcc
					where tax > 0 and (taxtype='1' or taxtype='5') and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
						((case when custno2!='' then custno2 else custno end)=@t_custno)
					union all --有發票系統
					select tax from vcca 
					where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno)
						and noa not in (select invono from view_vcc where tax > 0 and
						(datea not between @t_bvdate and @t_evdate)and
						((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno))
					),0)!=0)
		begin
			set @enddate=cast(CONVERT (VARCHAR(7),DATEADD(day, -1, convert(datetime,cast(cast(LEFT(@t_bvdate,3)as int)+1911 as nvarchar(10))+'/'+right(@t_bvdate,5))),12 )+0890000 as nvarchar(20))
			set @enddate=left(@enddate,3)+'/'+left(right(@enddate,4),2)+'/'+right(@enddate,2)

			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,unvcc,buvdate,euvdate)
			select '8' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
			,isnull((select  b.total from view_vccs b left join view_vcc a on a.noa = b.noa
			where (a.datea not between @t_bvdate and @t_evdate) and
				((case when a.mon='' then left(a.datea,6) else a.mon end) between @t_bvmon and @t_evmon)
				and(case when a.custno2!='' then a.custno2 else a.custno end)=@t_custno
			union all --無發票系統
			select tax	from view_vcc
			where tax > 0 and (taxtype='1' or taxtype='5') and
				(datea not between @t_bvdate and @t_evdate)and
				((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and
				((case when custno2!='' then custno2 else custno end)=@t_custno)
			union all --有發票系統
			select tax from vcca 
				where tax > 0 and (taxtype='1' or taxtype='5') and [2]!=3 and
				(datea not between @t_bvdate and @t_evdate)and
				((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno)
				and noa not in (select invono from view_vcc where tax > 0 and
				(datea not between @t_bvdate and @t_evdate)and
				((case when mon='' then left(datea,6) else mon end) between @t_bvmon and @t_evmon) and (custno =@t_custno))
			),0),@t_bvmon+'/01',@enddate
		end
		
		--已收金額
		if(select isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=@t_custno)),0) --本期單據以沖金額 
			+isnull((select SUM(ub.paysale) from umms ub 
			where charindex(@t_custno+'-',ub.vccno)>0 
			and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' between @t_bvdate and @t_evdate 
			and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) between @t_bvmon and @t_evmon),0))!=0
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '9' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
		end
		
		--預收累計
		if(@t_odate!='' and (select SUM(opay - unopay) total from umm where custno=@t_custno and datea<=@t_odate)!=0)
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,opay)
			select '10' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
			,(select SUM(opay - unopay) total from umm where custno=@t_custno and datea<=@t_odate)
		end
		
		--應收總計
		insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
		select '11' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
		
		--支票請開
		if((select count(*) from @result where custno=@t_custno and isnull(typea,'')='稅')>0)
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,acomp)
			select '12' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,
			(select sum(total) from vcca where noa in (select noa from @result where custno=@t_custno))
			, @t_pcount,(select top 1 acomp from vcca where noa in (select noa from @result where custno=@t_custno))
		end
				
		--支票請不開抬頭
		if(@t_total1-isnull((select sum(total) from vcca where noa in (select noa from @result where custno=@t_custno)),0)>50)
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '13' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1-isnull((select sum(total) from vcca where noa in (select noa from @result where custno=@t_custno)),0), @t_pcount
		end
		
		--請勿尾折
		if isnull((select MIN(paydate) from view_vcc where noa in (select noa from @result where custno=@t_custno) and ISNULL(paydate,'')!=''),'')!=''
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,paymemo)
			select '14' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
			,'到期日：'+ isnull((select MIN(paydate) from view_vcc where noa in (select noa from @result where custno=@t_custno) and ISNULL(paydate,'')!=''),'') +' 請勿尾折'
		end
		else
		begin	
			if charindex('貨到現金',(select top 1 paytype from cust where noa=@t_custno))>0
			or charindex('月結現金',(select top 1 paytype from cust where noa=@t_custno))>0
			or charindex('貨到現金',(select top 1 paytype from view_vcc where noa in(select noa from @result where custno=@t_custno) order by noa))>0
			or charindex('月結現金',(select top 1 paytype from view_vcc where noa in(select noa from @result where custno=@t_custno) order by noa))>0
			begin
				insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,paymemo)
				select '14' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
				,'付款方式：'+(select top 1 paytype from cust where noa=@t_custno)+' 請勿尾折'
			end
			else
			begin
				if(isnull((select paytype from cust where noa=@t_custno and CHARINDEX('天',paytype)>0),'')!='')
				begin
					set @endday=(select SUBSTRING(REPLACE(paytype,' ',''),patindex('%[0-9]%',REPLACE(paytype,' ','')),len(REPLACE(paytype,' ',''))-patindex('%[0-9]%',REPLACE(paytype,' ',''))-1) from cust where noa=@t_custno and CHARINDEX('天',paytype)>0)
					
					set @enddate=(select cast(CONVERT (VARCHAR(7),DATEADD(day, -1+@endday, convert(datetime,(convert(char(7),dateadd(month,1,
					case when @t_evmon !='' then cast(cast(LEFT(@t_evmon,3)as int)+1911 as nvarchar(10))+'/'+right(@t_evmon,2)+'/01' 
					when @t_evdate!='' then cast(cast(LEFT(@t_evdate,3)as int)+1911 as nvarchar(10))+'/'+right(@t_evdate,5)	else getdate() end ),111)+'/01'))),12 )+0890000 as nvarchar(20)))
					
					set @enddate=left(@enddate,3)+'/'+left(right(@enddate,4),2)+'/'+right(@enddate,2)
					
					insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,paymemo)
					select '14' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
					,'到期日：'+@enddate+' 請勿尾折'
				end
			end
		end
		
		--前期未付金額，請依上月發票抬頭開立支票
		if(select COUNT(*) from @tmpa where custno=@t_custno)>0
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '15' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
		end
		
		--收款明細
		if(@show_umm='1' and (select COUNT(*) from umm a left join umms b on a.noa=b.noa left join view_vcc c on b.vccno=c.noa where a.datea between @t_budate and @t_eudate and (case when a.custno!='' then a.custno when c.custno!='' then c.custno else c.custno2 end)=@t_custno and b.money>0)>0)
		begin
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
			select '16' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
					
			insert into @result(gno,noa,noq,mon,datea,custno,comp,cash,remit,lc,other,discount,checkno,bank,money,indate)
			select '17',a.noa,b.noq,'',a.datea, @t_custno, @t_comp comp
			,case when b.acc1 like '1111.%' then b.money else null end
			,case when b.acc1 like '1112.%' then b.money else null end
			,case when b.acc2 like '%LC%' or b.acc2 like '%L/C%' then b.money else null end
			,case when b.acc1 like '2123.%'then b.money else null end
			,case when b.acc1 like '4202.%' then b.money else null end
			,case when b.acc1 like '1121.%' then b.checkno else null end
			,case when b.acc1 like '1121.%' then b.bank else null end
			,case when b.acc1 like '1121.%' then b.money else null end
			,case when b.acc1 like '1121.%' then b.indate else null end
			from umm a left join umms b on a.noa=b.noa left join view_vcc c on b.vccno=c.noa where a.datea between @t_budate and @t_eudate and (case when a.custno!='' then a.custno when c.custno!='' then c.custno else c.custno2 end)=@t_custno and b.money>0
			
			insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount,fax)
			select '18' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax,@t_total1,@t_pcount
			,(select top 1 d.fax from umm a left join umms b on a.noa=b.noa left join view_vcc c on b.vccno=c.noa left join acomp d on a.cno=d.noa 
			where a.datea between @t_budate and @t_eudate and (case when a.custno!='' then a.custno when c.custno!='' then c.custno else c.custno2 end)=@t_custno)
		end
		
		--分頁
		insert into @result(gno,noa,noq,mon,datea,custno,comp,money,back,tax,total1,pcount)
		select '19' gno,'' ,'' ,'', '', @t_custno, @t_comp comp,@t_money, @t_back, @t_tax, @t_total1, @t_pcount
	end
	--***********************************************************************
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	
	--已收款 
	update a 
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where custno=a.custno)),0) --本期單據以沖金額 
	+isnull((select SUM(ub.paysale) from umms ub 
	where charindex(a.custno+'-',ub.vccno)>0 
	and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' between @t_bvdate and @t_evdate 
	and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) between @t_bvmon and @t_evmon),0) --找出月結客戶與稅的內容 
	from @result a where a.gno>='1'
	
	--插入本期無應收但前期有未收的客戶
	--insert @result (gno,noa,noq,datea,custno,mon,unmon,unpay)
	--select '7','','','',custno,mon,mon,money from @tmpa 
	--where custno not in (select custno from @result)
	
	--insert @result (gno,noa,noq,datea,custno,mon)
	--select '19','','','',custno,'' from @tmpa 
	--where custno not in (select custno from @result where gno='19') group by custno
	
	update a
	set unpay=isnull((select sum(money) from @tmpa where custno=a.custno),0)
	,pcount=(select count(*) from (select noa from @result where a.custno=custno and typea!='稅' and gno='0' group by noa) tmp)
	from @result a where a.gno>='1' and a.gno!='7'
	
	update @result
	set total2=total1+unpay-pay 
	where gno>='1'
	
	--update @result
	--set mount=mount*-1,total=total*-1
	--where typea='退'
	
	select case when @t_title!='' then @t_title else comp end comp
	,acomp axcomp
	,dbo.getComma(mount,[23])  mount
	,dbo.getComma(weight,[24])  weight
	,dbo.getComma(price,[25])  price
	,dbo.getComma(total,0)  total
	,dbo.getComma(money,0)  money
	,dbo.getComma(back,0)  back
	,dbo.getComma(tax,0)  tax
	,dbo.getComma(total1,0)  total1
	,dbo.getComma(pay,0)  pay
	,dbo.getComma(unpay,0)  unpay
	,dbo.getComma(unvcc,0)  unvcc
	,dbo.getComma(total2,0)  total2
	,dbo.getComma(btotal,0)  btotal
	,dbo.getComma(opay,0)  opay
	,dbo.getComma(cash,0)  cash
	,dbo.getComma(remit,0)  remit
	,dbo.getComma(lc,0)  lc
	,dbo.getComma(other,0)  other
	,dbo.getComma(discount,0)  discount
	,case when @t_evdate=char(255) then '帳款月份：' else '帳款日期：' end md1
	,case when @t_evdate=char(255) then @t_bvmon+'~'+@t_evmon else @t_bvdate+'~'+@t_evdate end md2
	,replace(product,'~#$',char(39)) product
	,*
	from @result order by custno,cast(gno as int),mon,datea,noa,noq;